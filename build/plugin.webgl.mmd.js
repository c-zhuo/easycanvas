!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var r in i)("object"==typeof exports?exports:t)[r]=i[r]}}(this,function(){return function(t){function e(r){if(i[r])return i[r].exports;var o=i[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}({0:function(t,e,i){t.exports=i(158)},17:function(t,e){"use strict";var i={},r={},o={},n={},s="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;i.create=function(t){var e=new s(3);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2]),e},i.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},i.add=function(t,e,i){return i&&t!=i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},i.subtract=function(t,e,i){return i&&t!=i?(i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},i.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},i.scale=function(t,e,i){return i&&t!=i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,t)},i.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],o=t[2],n=Math.sqrt(i*i+r*r+o*o);return n?1==n?(e[0]=i,e[1]=r,e[2]=o,e):(n=1/n,e[0]=i*n,e[1]=r*n,e[2]=o*n,e):(e[0]=0,e[1]=0,e[2]=0,e)},i.cross=function(t,e,i){i||(i=t);var r=t[0],o=t[1];t=t[2];var n=e[0],s=e[1];return e=e[2],i[0]=o*e-t*s,i[1]=t*n-r*e,i[2]=r*s-o*n,i},i.length=function(t){var e=t[0],i=t[1];return t=t[2],Math.sqrt(e*e+i*i+t*t)},i.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},i.direction=function(t,e,i){i||(i=t);var r=t[0]-e[0],o=t[1]-e[1];return t=t[2]-e[2],(e=Math.sqrt(r*r+o*o+t*t))?(e=1/e,i[0]=r*e,i[1]=o*e,i[2]=t*e,i):(i[0]=0,i[1]=0,i[2]=0,i)},i.lerp=function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r[2]=t[2]+i*(e[2]-t[2]),r},i.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"},r.create=function(t){var e=new s(9);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9]),e},r.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},r.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},r.transpose=function(t,e){if(!e||t==e){var i=t[1],r=t[2],o=t[5];return t[1]=t[3],t[2]=t[6],t[3]=i,t[5]=t[7],t[6]=r,t[7]=o,t}return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},r.toMat4=function(t,e){return e||(e=o.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},r.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"};var o={};o.create=function(t){var e=new s(16);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},o.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},o.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.transpose=function(t,e){if(!e||t==e){var i=t[1],r=t[2],o=t[3],n=t[6],s=t[7],a=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=i,t[6]=t[9],t[7]=t[13],t[8]=r,t[9]=n,t[11]=t[14],t[12]=o,t[13]=s,t[14]=a,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},o.determinant=function(t){var e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],s=t[5],a=t[6],h=t[7],p=t[8],u=t[9],f=t[10],l=t[11],c=t[12],m=t[13],_=t[14];return t=t[15],c*u*a*o-p*m*a*o-c*s*f*o+n*m*f*o+p*s*_*o-n*u*_*o-c*u*r*h+p*m*r*h+c*i*f*h-e*m*f*h-p*i*_*h+e*u*_*h+c*s*r*l-n*m*r*l-c*i*a*l+e*m*a*l+n*i*_*l-e*s*_*l-p*s*r*t+n*u*r*t+p*i*a*t-e*u*a*t-n*i*f*t+e*s*f*t},o.inverse=function(t,e){e||(e=t);var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=t[5],h=t[6],p=t[7],u=t[8],f=t[9],l=t[10],c=t[11],m=t[12],_=t[13],d=t[14],y=t[15],v=i*a-r*s,g=i*h-o*s,T=i*p-n*s,A=r*h-o*a,E=r*p-n*a,I=o*p-n*h,C=u*_-f*m,M=u*d-l*m,b=u*y-c*m,F=f*d-l*_,x=f*y-c*_,N=l*y-c*d,R=1/(v*N-g*x+T*F+A*b-E*M+I*C);return e[0]=(a*N-h*x+p*F)*R,e[1]=(-r*N+o*x-n*F)*R,e[2]=(_*I-d*E+y*A)*R,e[3]=(-f*I+l*E-c*A)*R,e[4]=(-s*N+h*b-p*M)*R,e[5]=(i*N-o*b+n*M)*R,e[6]=(-m*I+d*T-y*g)*R,e[7]=(u*I-l*T+c*g)*R,e[8]=(s*x-a*b+p*C)*R,e[9]=(-i*x+r*b-n*C)*R,e[10]=(m*E-_*T+y*v)*R,e[11]=(-u*E+f*T-c*v)*R,e[12]=(-s*F+a*M-h*C)*R,e[13]=(i*F-r*M+o*C)*R,e[14]=(-m*A+_*g-d*v)*R,e[15]=(u*A-f*g+l*v)*R,e},o.toRotationMat=function(t,e){return e||(e=o.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},o.toMat3=function(t,e){return e||(e=r.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},o.toInverseMat3=function(t,e){var i=t[0],o=t[1],n=t[2],s=t[4],a=t[5],h=t[6],p=t[8],u=t[9],f=t[10],l=f*a-h*u,c=-f*s+h*p,m=u*s-a*p,_=i*l+o*c+n*m;return _?(_=1/_,e||(e=r.create()),e[0]=l*_,e[1]=(-f*o+n*u)*_,e[2]=(h*o-n*a)*_,e[3]=c*_,e[4]=(f*i-n*p)*_,e[5]=(-h*i+n*s)*_,e[6]=m*_,e[7]=(-u*i+o*p)*_,e[8]=(a*i-o*s)*_,e):null},o.multiply=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],h=t[5],p=t[6],u=t[7],f=t[8],l=t[9],c=t[10],m=t[11],_=t[12],d=t[13],y=t[14];t=t[15];var v=e[0],g=e[1],T=e[2],A=e[3],E=e[4],I=e[5],C=e[6],M=e[7],b=e[8],F=e[9],x=e[10],N=e[11],R=e[12],S=e[13],B=e[14];return e=e[15],i[0]=v*r+g*a+T*f+A*_,i[1]=v*o+g*h+T*l+A*d,i[2]=v*n+g*p+T*c+A*y,i[3]=v*s+g*u+T*m+A*t,i[4]=E*r+I*a+C*f+M*_,i[5]=E*o+I*h+C*l+M*d,i[6]=E*n+I*p+C*c+M*y,i[7]=E*s+I*u+C*m+M*t,i[8]=b*r+F*a+x*f+N*_,i[9]=b*o+F*h+x*l+N*d,i[10]=b*n+F*p+x*c+N*y,i[11]=b*s+F*u+x*m+N*t,i[12]=R*r+S*a+B*f+e*_,i[13]=R*o+S*h+B*l+e*d,i[14]=R*n+S*p+B*c+e*y,i[15]=R*s+S*u+B*m+e*t,i},o.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],o=e[1];return e=e[2],i[0]=t[0]*r+t[4]*o+t[8]*e+t[12],i[1]=t[1]*r+t[5]*o+t[9]*e+t[13],i[2]=t[2]*r+t[6]*o+t[10]*e+t[14],i},o.multiplyVec4=function(t,e,i){i||(i=e);var r=e[0],o=e[1],n=e[2];return e=e[3],i[0]=t[0]*r+t[4]*o+t[8]*n+t[12]*e,i[1]=t[1]*r+t[5]*o+t[9]*n+t[13]*e,i[2]=t[2]*r+t[6]*o+t[10]*n+t[14]*e,i[3]=t[3]*r+t[7]*o+t[11]*n+t[15]*e,i},o.translate=function(t,e,i){var r=e[0],o=e[1];if(e=e[2],!i||t==i)return t[12]=t[0]*r+t[4]*o+t[8]*e+t[12],t[13]=t[1]*r+t[5]*o+t[9]*e+t[13],t[14]=t[2]*r+t[6]*o+t[10]*e+t[14],t[15]=t[3]*r+t[7]*o+t[11]*e+t[15],t;var n=t[0],s=t[1],a=t[2],h=t[3],p=t[4],u=t[5],f=t[6],l=t[7],c=t[8],m=t[9],_=t[10],d=t[11];return i[0]=n,i[1]=s,i[2]=a,i[3]=h,i[4]=p,i[5]=u,i[6]=f,i[7]=l,i[8]=c,i[9]=m,i[10]=_,i[11]=d,i[12]=n*r+p*o+c*e+t[12],i[13]=s*r+u*o+m*e+t[13],i[14]=a*r+f*o+_*e+t[14],i[15]=h*r+l*o+d*e+t[15],i},o.scale=function(t,e,i){var r=e[0],o=e[1];return e=e[2],i&&t!=i?(i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*r,i[4]=t[4]*o,i[5]=t[5]*o,i[6]=t[6]*o,i[7]=t[7]*o,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i):(t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=o,t[5]*=o,t[6]*=o,t[7]*=o,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t)},o.rotate=function(t,e,i,r){var o=i[0],n=i[1];i=i[2];var s=Math.sqrt(o*o+n*n+i*i);if(!s)return null;1!=s&&(s=1/s,o*=s,n*=s,i*=s);var a=Math.sin(e),h=Math.cos(e),p=1-h;e=t[0],s=t[1];var u=t[2],f=t[3],l=t[4],c=t[5],m=t[6],_=t[7],d=t[8],y=t[9],v=t[10],g=t[11],T=o*o*p+h,A=n*o*p+i*a,E=i*o*p-n*a,I=o*n*p-i*a,C=n*n*p+h,M=i*n*p+o*a,b=o*i*p+n*a;return o=n*i*p-o*a,n=i*i*p+h,r?t!=r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=e*T+l*A+d*E,r[1]=s*T+c*A+y*E,r[2]=u*T+m*A+v*E,r[3]=f*T+_*A+g*E,r[4]=e*I+l*C+d*M,r[5]=s*I+c*C+y*M,r[6]=u*I+m*C+v*M,r[7]=f*I+_*C+g*M,r[8]=e*b+l*o+d*n,r[9]=s*b+c*o+y*n,r[10]=u*b+m*o+v*n,r[11]=f*b+_*o+g*n,r},o.rotateX=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var o=t[4],n=t[5],s=t[6],a=t[7],h=t[8],p=t[9],u=t[10],f=t[11];return i?t!=i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[4]=o*e+h*r,i[5]=n*e+p*r,i[6]=s*e+u*r,i[7]=a*e+f*r,i[8]=o*-r+h*e,i[9]=n*-r+p*e,i[10]=s*-r+u*e,i[11]=a*-r+f*e,i},o.rotateY=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var o=t[0],n=t[1],s=t[2],a=t[3],h=t[8],p=t[9],u=t[10],f=t[11];return i?t!=i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=o*e+h*-r,i[1]=n*e+p*-r,i[2]=s*e+u*-r,i[3]=a*e+f*-r,i[8]=o*r+h*e,i[9]=n*r+p*e,i[10]=s*r+u*e,i[11]=a*r+f*e,i},o.rotateZ=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var o=t[0],n=t[1],s=t[2],a=t[3],h=t[4],p=t[5],u=t[6],f=t[7];return i?t!=i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=o*e+h*r,i[1]=n*e+p*r,i[2]=s*e+u*r,i[3]=a*e+f*r,i[4]=o*-r+h*e,i[5]=n*-r+p*e,i[6]=s*-r+u*e,i[7]=a*-r+f*e,i},o.frustum=function(t,e,i,r,n,s,a){a||(a=o.create());var h=e-t,p=r-i,u=s-n;return a[0]=2*n/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*n/p,a[6]=0,a[7]=0,a[8]=(e+t)/h,a[9]=(r+i)/p,a[10]=-(s+n)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(s*n*2)/u,a[15]=0,a},o.perspective=function(t,e,i,r,n){return t=i*Math.tan(t*Math.PI/360),e*=t,o.frustum(-e,e,-t,t,i,r,n)},o.ortho=function(t,e,i,r,n,s,a){a||(a=o.create());var h=e-t,p=r-i,u=s-n;return a[0]=2/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/p,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(t+e)/h,a[13]=-(r+i)/p,a[14]=-(s+n)/u,a[15]=1,a},o.lookAt=function(t,e,i,r){r||(r=o.create());var n=t[0],s=t[1];t=t[2];var a=i[0],h=i[1],p=i[2];i=e[1];var u=e[2];if(n==e[0]&&s==i&&t==u)return o.identity(r);var f,l,c,m;return i=n-e[0],u=s-e[1],e=t-e[2],m=1/Math.sqrt(i*i+u*u+e*e),i*=m,u*=m,e*=m,f=h*e-p*u,p=p*i-a*e,a=a*u-h*i,(m=Math.sqrt(f*f+p*p+a*a))?(m=1/m,f*=m,p*=m,a*=m):a=p=f=0,h=u*a-e*p,l=e*f-i*a,c=i*p-u*f,(m=Math.sqrt(h*h+l*l+c*c))?(m=1/m,h*=m,l*=m,c*=m):c=l=h=0,r[0]=f,r[1]=h,r[2]=i,r[3]=0,r[4]=p,r[5]=l,r[6]=u,r[7]=0,r[8]=a,r[9]=c,r[10]=e,r[11]=0,r[12]=-(f*n+p*s+a*t),r[13]=-(h*n+l*s+c*t),r[14]=-(i*n+u*s+e*t),r[15]=1,r},o.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"},n={},n.create=function(t){var e=new s(4);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e},n.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},n.calculateW=function(t,e){var i=t[0],r=t[1],o=t[2];return e&&t!=e?(e[0]=i,e[1]=r,e[2]=o,e[3]=-Math.sqrt(Math.abs(1-i*i-r*r-o*o)),e):(t[3]=-Math.sqrt(Math.abs(1-i*i-r*r-o*o)),t)},n.inverse=function(t,e){return e&&t!=e?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e):(t[0]*=1,t[1]*=1,t[2]*=1,t)},n.length=function(t){var e=t[0],i=t[1],r=t[2];return t=t[3],Math.sqrt(e*e+i*i+r*r+t*t)},n.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],o=t[2],n=t[3],s=Math.sqrt(i*i+r*r+o*o+n*n);return 0==s?(e[0]=0,e[1]=0,e[2]=0,e[3]=0,e):(s=1/s,e[0]=i*s,e[1]=r*s,e[2]=o*s,e[3]=n*s,e)},n.multiply=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2];t=t[3];var s=e[0],a=e[1],h=e[2];return e=e[3],i[0]=r*e+t*s+o*h-n*a,i[1]=o*e+t*a+n*s-r*h,i[2]=n*e+t*h+r*a-o*s,i[3]=t*e-r*s-o*a-n*h,i},n.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],o=e[1],n=e[2];e=t[0];var s=t[1],a=t[2];t=t[3];var h=t*r+s*n-a*o,p=t*o+a*r-e*n,u=t*n+e*o-s*r;return r=-e*r-s*o-a*n,i[0]=h*t+r*-e+p*-a-u*-s,i[1]=p*t+r*-s+u*-e-h*-a,i[2]=u*t+r*-a+h*-s-p*-e,i},n.toMat3=function(t,e){e||(e=r.create());var i=t[0],o=t[1],n=t[2],s=t[3],a=i+i,h=o+o,p=n+n,u=i*a,f=i*h;i*=p;var l=o*h;return o*=p,n*=p,a*=s,h*=s,s*=p,e[0]=1-(l+n),e[1]=f-s,e[2]=i+h,e[3]=f+s,e[4]=1-(u+n),e[5]=o-a,e[6]=i-h,e[7]=o+a,e[8]=1-(u+l),e},n.toMat4=function(t,e){e||(e=o.create());var i=t[0],r=t[1],n=t[2],s=t[3],a=i+i,h=r+r,p=n+n,u=i*a,f=i*h;i*=p;var l=r*h;return r*=p,n*=p,a*=s,h*=s,s*=p,e[0]=1-(l+n),e[1]=f-s,e[2]=i+h,e[3]=0,e[4]=f+s,e[5]=1-(u+n),e[6]=r-a,e[7]=0,e[8]=i-h,e[9]=r+a,e[10]=1-(u+l),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},n.slerp=function(t,e,i,r){r||(r=t);var o=i;return 0>t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]&&(o=-1*i),r[0]=1-i*t[0]+o*e[0],r[1]=1-i*t[1]+o*e[1],r[2]=1-i*t[2]+o*e[2],r[3]=1-i*t[3]+o*e[3],r},n.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"},t.exports={vec3:i,mat3:r,mat4:o,quat4:n}},29:function(t,e){"use strict";function i(t,e){var i=function(t){function e(){}return Object.create?Object.create(t):(e.prototype=t,new e)};t.prototype=i(e.prototype),t.prototype.constructor=t}t.exports=i},49:function(t,e,i){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(){this.workNum=10,this.workTrs=[],this.workQs=[],this.workVs=[];for(var t=0;this.workNum>t;t++)this.workTrs[t]=new Ammo.btTransform,this.workQs[t]=new Ammo.btQuaternion,this.workVs[t]=new Ammo.btVector3}function n(t,e,i){this.parent=o,this.parent.call(this),this.pmd=t,this.world=e,this.body=i,this.rb=null,this.bone=null,this.form=null,this.boneForm=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}function s(t,e,i,r,n){this.parent=o,this.parent.call(this),this.pmd=t,this.world=e,this.joint=i,this.bodyA=r,this.bodyB=n,this.constraint=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}function a(t){this.pmd=t,this.world=null,this.bodies=[],this.constraints=[],this.count=0,this._init()}var h=i(29),p=r(h),u=i(17);o.prototype.allocTr=function(){var t=this.workTrs[this.workTrs.length-1];return this.workTrs.length--,t},o.prototype.freeTr=function(t){this.workTrs[this.workTrs.length]=t},o.prototype.allocQ=function(){var t=this.workQs[this.workQs.length-1];return this.workQs.length--,t},o.prototype.freeQ=function(t){this.workQs[this.workQs.length]=t},o.prototype.allocV=function(){var t=this.workVs[this.workVs.length-1];return this.workVs.length--,t},o.prototype.freeV=function(t){this.workVs[this.workVs.length]=t},o.prototype._newTransform=function(){return new Ammo.btTransform},o.prototype._setIdentity=function(t){t.setIdentity()},o.prototype._getBasis=function(t){var e=this.allocQ();return t.getBasis().getRotation(e),e},o.prototype._getBasisMatrix3=function(t){var e=this._getBasis(t),i=this._quaternionToMatrix3(e);return this.freeQ(e),i},o.prototype._setBasis=function(t,e){t.setRotation(e)},o.prototype._setBasisMatrix3=function(t,e){var i=this._matrix3ToQuaternion(e);this._setBasis(t,i),this.freeQ(i)},o.prototype._setBasisArray4=function(t,e){var i=this._array4ToQuaternion(e);this._setBasis(t,i),this.freeQ(i)},o.prototype._setBasisArray4Left=function(t,e){e[0]=-e[0],e[1]=-e[1],this._setBasisArray4(t,e),e[0]=-e[0],e[1]=-e[1]},o.prototype._setBasisArray3=function(t,e){t.getBasis().setEulerZYX(e[0],e[1],e[2])},o.prototype._setBasisArray3Left=function(t,e){e[0]=-e[0],e[1]=-e[1],this._setBasisArray3(t,e),e[0]=-e[0],e[1]=-e[1]},o.prototype._getOrigin=function(t){return t.getOrigin()},o.prototype._getOriginArray3=function(t){var e=this._getOrigin(t);return[e.x(),e.y(),e.z()]},o.prototype._setOrigin=function(t,e){t.getOrigin().setValue(e.x(),e.y(),e.z())},o.prototype._setOriginArray3=function(t,e){t.getOrigin().setValue(e[0],e[1],e[2])},o.prototype._setOriginArray3Left=function(t,e){e[2]=-e[2],this._setOriginArray3(t,e),e[2]=-e[2]},o.prototype._setOriginFloats=function(t,e,i,r){t.getOrigin().setValue(e,i,r)},o.prototype._copyOrigin=function(t,e){var i=e.getOrigin();this._setOrigin(t,i)},o.prototype._addVector3=function(t,e){var i=this.allocV();return i.setValue(t.x()+e.x(),t.y()+e.y(),t.z()+e.z()),i},o.prototype._addVector3ByArray3=function(t,e){var i=this.allocV();return i.setValue(t.x()+e[0],t.y()+e[1],t.z()+e[2]),i},o.prototype._dotVectors3=function(t,e){return t.x()*e.x()+t.y()*e.y()+t.z()*e.z()},o.prototype._rowOfMatrix3=function(t,e){var i=this.allocV();return i.setValue(t[3*e+0],t[3*e+1],t[3*e+2]),i},o.prototype._columnOfMatrix3=function(t,e){var i=this.allocV();return i.setValue(t[e+0],t[e+3],t[e+6]),i},o.prototype._negativeVector3=function(t){var e=this.allocV();return e.setValue(-t.x(),-t.y(),-t.z()),e},o.prototype._cloneVector3=function(t){var e=this.allocV();return e.setValue(t.x(),t.y(),t.z()),e},o.prototype._cloneMatrix3=function(t){for(var e=[],i=0;9>i;i++)e[i]=t[i];return e},o.prototype._array3ToVector3=function(t){var e=this.allocV();return e.setValue(t[0],t[1],t[2]),e},o.prototype._vector3ToArray3=function(t){var e=[];return e[0]=t.x(),e[1]=t.y(),e[2]=t.z(),e},o.prototype._array4ToQuaternion=function(t){var e=this.allocQ();return e.setX(t[0]),e.setY(t[1]),e.setZ(t[2]),e.setW(t[3]),e},o.prototype._quaternionToArray4=function(t){var e=[t.x(),t.y(),t.z(),t.w()];return e},o.prototype._quaternionToEulerZYX=function(t){var e,i,r,o=t.w(),n=t.x(),s=t.y(),a=t.z(),h=n*n,p=s*s,u=n*s+a*o;if(u>.499)r=360/Math.PI*Math.atan2(n,o),i=90,e=0;else if(-.499>u)r=-360/Math.PI*Math.atan2(n,o),i=-90,r=0;else{var f=Math.atan2(2*s*o-2*n*a,1-2*p-2*a),l=Math.asin(2*n*s+2*a*o),c=Math.atan2(2*n*o-2*s*a,1-2*h-2*a);r=Math.round(180*f/Math.PI),i=Math.round(180*l/Math.PI),e=Math.round(180*c/Math.PI)}return[e,r,i];var e,i,r},o.prototype._multiplyTransforms=function(t,e){var i=this.allocTr();i.setIdentity();var r=this._getBasisMatrix3(t),o=this._getBasisMatrix3(e),n=this._getOrigin(t),s=this._getOrigin(e),a=this._multiplyMatrix3ByVector3(r,s),h=this._addVector3(a,n);this._setOrigin(i,h);var p=this._multiplyMatrices3(r,o);return this._setBasisMatrix3(i,p),this.freeV(a),this.freeV(h),i},o.prototype._inverseTransform=function(t){var e=this.allocTr(),i=this._getBasisMatrix3(t),r=this._getOrigin(t),o=this._transposeMatrix3(i),n=this._negativeVector3(r),s=this._multiplyMatrix3ByVector3(o,n);return this._setOrigin(e,s),this._setBasisMatrix3(e,o),this.freeV(n),this.freeV(s),e},o.prototype._multiplyTransformByVector3=function(t,e){var i=this._getBasisMatrix3(t),r=this._getOrigin(t),o=this._multiplyMatrix3ByVector3(i,e),n=this._addVector3(o,r);return this.freeV(o),n},o.prototype._multiplyMatrix3ByVector3=function(t,e){var i=this.allocV(),r=this._rowOfMatrix3(t,0),o=this._rowOfMatrix3(t,1),n=this._rowOfMatrix3(t,2),s=this._dotVectors3(r,e),a=this._dotVectors3(o,e),h=this._dotVectors3(n,e);return i.setValue(s,a,h),this.freeV(r),this.freeV(o),this.freeV(n),i},o.prototype._multiplyMatrices3=function(t,e){var i=[],r=this._rowOfMatrix3(t,0),o=this._rowOfMatrix3(t,1),n=this._rowOfMatrix3(t,2),s=this._columnOfMatrix3(e,0),a=this._columnOfMatrix3(e,1),h=this._columnOfMatrix3(e,2);return i[0]=this._dotVectors3(r,s),i[1]=this._dotVectors3(r,a),i[2]=this._dotVectors3(r,h),i[3]=this._dotVectors3(o,s),i[4]=this._dotVectors3(o,a),i[5]=this._dotVectors3(o,h),i[6]=this._dotVectors3(n,s),i[7]=this._dotVectors3(n,a),i[8]=this._dotVectors3(n,h),this.freeV(r),this.freeV(o),this.freeV(n),this.freeV(s),this.freeV(a),this.freeV(h),i},o.prototype._transposeMatrix3=function(t){var e=[];return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},o.prototype._inverseMatrix3=function(t){var e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],s=t[5],a=t[6],h=t[7],p=t[8],u=e*n*p+o*h*r+a*i*s-a*n*r-o*i*p-e*h*s;if(0==u)return this._cloneMatrix3(t);var f=[];return f[0]=(n*p-s*h)/u,f[1]=(r*h-i*p)/u,f[2]=(i*s-r*n)/u,f[3]=(s*a-o*p)/u,f[4]=(e*p-r*a)/u,f[5]=(r*o-e*s)/u,f[6]=(o*h-n*a)/u,f[7]=(i*a-e*h)/u,f[8]=(e*n-i*o)/u,f},o.prototype._quaternionToMatrix3=function(t){var e=u.quat4.create();return e[0]=t.x(),e[1]=t.y(),e[2]=t.z(),e[3]=t.w(),u.quat4.toMat3(e)},o.prototype._matrix3ToQuaternion=function(t){var e,i,r,o,n,s=t[0]+t[4]+t[8];s>0?(e=2*Math.sqrt(s+1),n=.25*e,i=(t[7]-t[5])/e,r=(t[2]-t[6])/e,o=(t[3]-t[1])/e):t[0]>t[4]&&t[0]>t[8]?(e=2*Math.sqrt(1+t[0]-t[4]-t[8]),n=(t[7]-t[5])/e,i=.25*e,r=(t[1]+t[3])/e,o=(t[2]+t[6])/e):t[4]>t[8]?(e=2*Math.sqrt(1+t[4]-t[0]-t[8]),n=(t[2]-t[6])/e,i=(t[1]+t[3])/e,r=.25*e,o=(t[5]+t[7])/e):(e=2*Math.sqrt(1+t[8]-t[0]-t[4]),n=(t[3]-t[1])/e,i=(t[2]+t[6])/e,r=(t[5]+t[7])/e,o=.25*e);var a=this.allocQ();return a.setX(i),a.setY(r),a.setZ(o),a.setW(n),a},o.prototype._dumpTransform=function(t){var e=this._getBasis(t),i="";return i+="-- origin --\n",i+=""+this._getOriginArray3(t)+"\n",i+="-- quaternion --\n",i+=""+[e.x(),e.y(),e.z(),e.w()]+"\n",i+="-- matrix --\n",i+=this._dumpMatrix3(this._getBasisMatrix3(t)),this.freeQ(e),i},o.prototype._dumpMatrix3=function(t){for(var e="",i=0;3>i;i++)e+=""+[t[3*i+0],t[3*i+1],t[3*i+2]]+",\n";return e},(0,p.default)(n,o),n.prototype._init=function(){var t=this.body,e=this.pmd.bones[t.boneIndex],i=this._generateShape(t),r=0==t.type?0:t.weight,o=this.allocV();o.setValue(0,0,0),0!=r&&i.calculateLocalInertia(r,o);var n=this.allocTr();this._setIdentity(n),this._setOriginArray3Left(n,t.position),this._setBasisArray3Left(n,t.rotation);var s=this.allocTr();this._setIdentity(s);var a=65535==this.body.boneIndex?[0,0,0]:e.position;this._setOriginArray3Left(s,a);var h=this._multiplyTransforms(s,n),p=new Ammo.btDefaultMotionState(h),u=new Ammo.btRigidBodyConstructionInfo(r,p,i,o);u.set_m_friction(t.friction),u.set_m_restitution(t.recoil);var f=new Ammo.btRigidBody(u);0==t.type&&(f.setCollisionFlags(2|f.getCollisionFlags()),f.setActivationState(4)),f.setDamping(t.positionDim,t.rotationDim),f.setSleepingThresholds(0,0),this.world.addRigidBody(f,1<<t.groupIndex,t.groupTarget),this.rb=f,this.bone=e,this.boneOffsetForm=n,this.boneOffsetFormInverse=this._inverseTransform(n),this.freeV(o),this.freeTr(h),this.freeTr(s)},n.prototype._generateShape=function(t){switch(t.shapeType){case 0:return new Ammo.btSphereShape(t.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(t.width,t.height,t.depth));case 2:return new Ammo.btCapsuleShape(t.width,t.height);default:throw"unknown shape type."+t}},n.prototype.reset=function(t){this._setTransformFromBone(t)},n.prototype.preSimulation=function(t){65535!=this.body.boneIndex&&(0==this.body.type&&this._setTransformFromBone(t),2==this.body.type&&this._setPositionFromBone(t))},n.prototype._setTransformFromBone=function(t){var e=t[this.body.boneIndex];65535==this.body.boneIndex&&(e={p:[0,0,0],r:[0,0,0,1]});var i=this.allocTr();this._setOriginArray3Left(i,e.p),this._setBasisArray4Left(i,e.r);var r=this._multiplyTransforms(i,this.boneOffsetForm);this.rb.setCenterOfMassTransform(r),this.rb.getMotionState().setWorldTransform(r),this.freeTr(i),this.freeTr(r)},n.prototype._setPositionFromBone=function(t){var e=t[this.body.boneIndex],i=this.allocTr();this._setOriginArray3Left(i,e.p),this._setBasisArray4Left(i,e.r);var r=this._multiplyTransforms(i,this.boneOffsetForm),o=this.allocTr();this.rb.getMotionState().getWorldTransform(o),this._copyOrigin(o,r),this.rb.setCenterOfMassTransform(o),this.rb.getMotionState().setWorldTransform(o),this.freeTr(i),this.freeTr(o),this.freeTr(r)},n.prototype.postSimulation=function(t){if(0!=this.body.type&&65535!=this.body.boneIndex){var e=t[this.body.boneIndex],i=this.allocTr();this.rb.getMotionState().getWorldTransform(i);var r=this._multiplyTransforms(i,this.boneOffsetFormInverse),o=this._getBasis(r);if(e.r[0]=-o.x(),e.r[1]=-o.y(),e.r[2]=o.z(),e.r[3]=o.w(),1==this.body.type){var n=this._getOrigin(r);e.p[0]=n.x(),e.p[1]=n.y(),e.p[2]=-n.z()}this.freeQ(o),this.freeTr(i),this.freeTr(r)}},(0,p.default)(s,o),s.prototype._init=function(){var t=this.joint,e=this.bodyA.rb,i=this.bodyB.rb,r=this.bodyA.body,o=this.bodyB.body;if(0!==r.type&&2==o.type&&r.boneIndex>0&&o.boneIndex>0&&65535!=r.boneIndex&&65535!=o.boneIndex){var n=this.pmd.bones[r.boneIndex],s=this.pmd.bones[o.boneIndex];s.parentIndex==n.id&&(o.type=1)}var a=this.allocTr();this._setOriginArray3Left(a,t.position),this._setBasisArray3Left(a,t.rotation);var h=e.getWorldTransform(),p=i.getWorldTransform(),u=this._inverseTransform(h),f=this._inverseTransform(p),l=this._multiplyTransforms(u,a),c=this._multiplyTransforms(f,a),m=new Ammo.btGeneric6DofSpringConstraint(e,i,l,c,!0),_=this.allocV(),d=this.allocV(),y=this.allocV(),v=this.allocV();_.setValue(t.translationLimitation1[0],t.translationLimitation1[1],-t.translationLimitation2[2]),d.setValue(t.translationLimitation2[0],t.translationLimitation2[1],-t.translationLimitation1[2]),y.setValue(-t.rotationLimitation2[0],-t.rotationLimitation2[1],t.rotationLimitation1[2]),v.setValue(-t.rotationLimitation1[0],-t.rotationLimitation1[1],t.rotationLimitation2[2]),m.setLinearLowerLimit(_),m.setLinearUpperLimit(d),m.setAngularLowerLimit(y),m.setAngularUpperLimit(v);for(var g=0;3>g;g++)0!=t.springPosition[g]&&(m.enableSpring(g,!0),m.setStiffness(g,t.springPosition[g]));for(var g=0;3>g;g++)0!=t.springRotation[g]&&(m.enableSpring(g+3,!0),m.setStiffness(g+3,t.springRotation[g]));this.world.addConstraint(m,!0),this.constraint=m,this.freeTr(a),Ammo.destroy(h),Ammo.destroy(p),this.freeTr(u),this.freeTr(f),this.freeTr(l),this.freeTr(c),this.freeV(_),this.freeV(d),this.freeV(y),this.freeV(v)},a.prototype._init=function(){this.world=this._generateWorld(),this.bodies.length=0;for(var t=0;this.pmd.rigidBodyCount>t;t++)this.bodies.push(new n(this.pmd,this.world,this.pmd.rigidBodies[t]));this.constraints.length=0;for(var t=0;this.pmd.jointCount>t;t++){var e=this.pmd.joints[t],i=this.bodies[e.rigidBody1],r=this.bodies[e.rigidBody2];this.constraints.push(new s(this.pmd,this.world,e,i,r))}},a.prototype._generateWorld=function(){var t=new Ammo.btDefaultCollisionConfiguration,e=new Ammo.btCollisionDispatcher(t),i=new Ammo.btDbvtBroadphase,r=new Ammo.btSequentialImpulseConstraintSolver,o=new Ammo.btDiscreteDynamicsWorld(e,i,r,t);return o.setGravity(new Ammo.btVector3(0,-100,0)),o},a.prototype._generateGround=function(){var t=new Ammo.btTransform;return t.setIdentity(),t.setOrigin(new Ammo.btVector3(0,-1,0)),new Ammo.btRigidBody(new Ammo.btRigidBodyConstructionInfo(0,new Ammo.btDefaultMotionState(t),new Ammo.btBoxShape(new Ammo.btVector3(5,1,5)),new Ammo.btVector3(0,0,0)))},a.prototype.simulate=function(t,e){this._preSimulation(t),this.world.stepSimulation(1/60,0,1/60),this._postSimulation(t)},a.prototype.simulateFrame=function(t,e){var i,r=1/60*e,o=e,n=1/60;3>e||(o=2,n=1/60*2,i=this.world.getGravity(),i.setY(-50),this.world.setGravity(i)),this._preSimulation(t),this.world.stepSimulation(r,o,n),this._postSimulation(t),3>e||(i.setY(-100),this.world.setGravity(i),Ammo.destroy(i))},a.prototype._preSimulation=function(t){for(var e=0;this.bodies.length>e;e++)this.bodies[e].preSimulation(t)},a.prototype._postSimulation=function(t){for(var e=0;this.bodies.length>e;e++)this.bodies[e].postSimulation(t)},a.prototype.resetRigidBodies=function(t){for(var e=0;this.bodies.length>e;e++)this.bodies[e].reset(t)},t.exports=a},50:function(t,e){"use strict";function i(){this.header=null,this.englishHeader=null,this.vertexCount=null,this.vertexIndexCount=null,this.materialCount=null,this.boneCount=null,this.ikCount=null,this.faceCount=null,this.faceDisplayCount=null,this.boneFrameNameCount=null,this.boneDisplayCount=null,this.toonTextureCount=null,this.rigidBodyCount=null,this.jointCount=null,this.vertices=[],this.vertexIndices=[],this.materials=[],this.bones=[],this.iks=[],this.faces=[],this.faceDisplays=[],this.boneFrameNames=[],this.boneDisplays=[],this.englishBoneNames=[],this.englishFaceNames=[],this.englishBoneFrameNames=[],this.toonTextures=[],this.rigidBodies=[],this.joints=[],this.bonesHash={},this.facesHash={},this.images=[],this.toonImages=[],this.sphereImages=[],this.centerBone={},this.leftFootBone={},this.rightFootBone={},this.leftEyeBone={},this.rightEyeBone={}}function r(){this.magic=null,this.version=null,this.modelName=null,this.comment=null}function o(t){this.id=t,this.position=null,this.normal=null,this.uv=null,this.boneIndices=null,this.boneWeight=null,this.edgeFlag=null,this.boneWeightFloat1=null,this.boneWeightFloat2=null}function n(t){this.id=t,this.index=null}function s(t){this.id=t,this.color=null,this.specularity=null,this.specularColor=null,this.mirrorColor=null,this.tuneIndex=null,this.edgeFlag=null,this.vertexCount=null,this.fileName=null}function a(t){this.id=t,this.name=null,this.parentIndex=null,this.tailIndex=null,this.type=null,this.ikIndex=null,this.position=null,this.motionIndex=null}function h(t){this.id=t,this.index=null,this.targetBoneIndex=null,this.chainLength=null,this.iteration=null,this.limitation=null,this.childBoneIndices=null}function p(t){this.id=t,this.name=null,this.vertexCount=null,this.type=null,this.vertices=null,this.done=!1,this.motionIndex=null}function u(t,e){this.id=t,this.type=e,this.index=null,this.position=null}function f(t){this.id=t,this.index=null}function l(t){this.id=t,this.name=null}function c(t){this.id=t,this.index=null,this.frameIndex=null}function m(){this.compatibility=null,this.modelName=null,this.comment=null}function _(t){this.id=t,this.name=null}function d(t){this.id=t,this.name=null}function y(t){this.id=t,this.name=null}function v(t){this.id=t,this.fileName=null}function g(t){this.id=t,this.name=null,this.boneIndex=null,this.groupIndex=null,this.groupTarget=null,this.shapeType=null,this.width=null,this.height=null,this.depth=null,this.position=null,this.rotation=null,this.weight=null,this.positionDim=null,this.rotationDim=null,this.recoil=null,this.friction=null,this.type=null}function T(t){this.id=t,this.name=null,this.rigidBody1=null,this.rigidBody2=null,this.position=null,this.rotation=null,this.translationLimitation1=null,this.translationLimitation2=null,this.rotationLimitation1=null,this.rotationLimitation2=null,this.springPosition=null,this.springRotation=null}function A(t,e){this.pmd=t,this.baseURL=e,this.errorImageNum=0,this.loadedImageNum=0,this.noImageNum=0}i.prototype.valid=function(){return this.header.valid()},i.prototype.getParentBone=function(t){return this.bones[t.parentIndex]},i.prototype.loadImages=function(t,e){var i=new A(this,t);i.load(e)},i.prototype.setup=function(){for(var t=0;this.vertexCount>t;t++)this.vertices[t].setup();for(var t=0;this.boneCount>t;t++)this.bonesHash[this.bones[t].name]=this.bones[t];for(var t=0;this.faceCount>t;t++)this.facesHash[this.faces[t].name]=this.faces[t];this._keepSomeBonesInfo()},i.prototype.toRight=function(){for(var t=0;this.vertexCount>t;t++)this.vertices[t].toRight();for(var t=0;this.boneCount>t;t++)this.bones[t].toRight();for(var t=0;this.faceCount>t;t++)this.faces[t].toRight();for(var t=0;this.rigidBodyCount>t;t++)this.rigidBodies[t].toRight();for(var t=0;this.jointCount>t;t++)this.joints[t].toRight()},i.prototype._keepSomeBonesInfo=function(){this._keepBoneInfo(this.centerBone,"0x830x5a0x830x930x830x5e0x810x5b"),this._keepBoneInfo(this.leftFootBone,"0x8d0xb60x910xab0x8e0xf1"),this._keepBoneInfo(this.rightFootBone,"0x890x450x910xab0x8e0xf1"),this._keepBoneInfo(this.leftEyeBone,"0x8d0xb60x960xda"),this._keepBoneInfo(this.rightEyeBone,"0x890x450x960xda")},i.prototype._keepBoneInfo=function(t,e){var i=this._findBoneNumberByName(e);if(null!==i){var r=this.bones[i];t.pos=this._getAveragePositionOfBone(r),t.id=i,t.bone=r,t.posFromBone=[],t.posFromBone[0]=t.pos[0]-r.position[0],t.posFromBone[1]=t.pos[1]-r.position[1],t.posFromBone[2]=t.pos[2]-r.position[2]}else t.pos=null,t.id=null,t.bone=null,t.posFromBone=null},i.prototype._findBoneNumberByName=function(t){for(var e=0;this.boneCount>e;e++)if(this.bones[e].name==t)return e;return null},i.prototype._getAveragePositionOfBone=function(t){for(var e=0,i=[0,0,0],r=0;this.vertexCount>r;r++){var o=this.vertices[r];o.boneIndices[0]!=t.id&&o.boneIndices[1]!=t.id||(i[0]+=o.position[0],i[1]+=o.position[1],i[2]+=o.position[2],e++)}return 0!=e&&(i[0]=i[0]/e,i[1]=i[1]/e,i[2]=i[2]/e),i},i.prototype.getBoneNames=function(){for(var t=[],e=0;this.boneCount>e;e++)t[e]=this.bones[e].name;return t},i.prototype.getFaceNames=function(){for(var t=[],e=0;this.faceCount>e;e++)t[e]=this.faces[e].name;return t},i.prototype.dump=function(){var t="";return t+="vertexCount: "+this.vertexCount+"\n",t+="vertexIndexCount: "+this.vertexIndexCount+"\n",t+="materialCount: "+this.materialCount+"\n",t+="boneCount: "+this.boneCount+"\n",t+="ikCount: "+this.ikCount+"\n",t+="faceCount: "+this.faceCount+"\n",
t+="faceDisplayCount: "+this.faceDisplayCount+"\n",t+="boneFrameNameCount: "+this.boneFrameNameCount+"\n",t+="boneDisplayCount: "+this.boneDisplayCount+"\n",t+="toonTextureCount: "+this.toonTextureCount+"\n",t+="rigidBodyCount: "+this.rigidBodyCount+"\n",t+="jointCount: "+this.jointCount+"\n",t+="\n",t+=this._dumpHeader(),t+=this._dumpVertices(),t+=this._dumpVertexIndices(),t+=this._dumpMaterials(),t+=this._dumpBones(),t+=this._dumpIKs(),t+=this._dumpFaces(),t+=this._dumpfaceDisplays(),t+=this._dumpBoneFrameNames(),t+=this._dumpBoneDisplays(),t+=this._dumpEnglishHeader(),t+=this._dumpEnglishBoneNames(),t+=this._dumpEnglishFaceNames(),t+=this._dumpToonTextures(),t+=this._dumpRigidBodies(),t+=this._dumpJoints()},i.prototype.boneNumsOfMaterials=function(){for(var t=0,e=[],i=0;this.materialCount>i;i++){for(var r=[],o=0;this.boneCount>o;o++)r[o]=0;for(var n=0,s=this.materials[i].vertexCount,o=0;s>o;o++)for(var a=this.vertices[this.vertexIndices[t+o].index],h=0;a.boneIndices.length>h;h++){var p=a.boneIndices[h];0==r[p]&&n++,r[p]++}e.push(n),t+=s}return e},i.prototype._dumpHeader=function(){var t="";return t+="-- Header --\n",t+=this.header.dump(),t+="\n"},i.prototype._dumpEnglishHeader=function(){var t="";return t+="-- Header(English) --\n",t+=this.englishHeader.dump(),t+="\n"},i.prototype._dumpVertices=function(){var t="";t+="-- Vertices --\n";for(var e=0;this.vertexCount>e;e++)t+=this.vertices[e].dump();return t+="\n"},i.prototype._dumpVertexIndices=function(){var t="";t+="-- VertexIndices --\n";for(var e=0;this.vertexIndexCount>e;e++)t+=this.vertexIndices[e].dump();return t+="\n"},i.prototype._dumpMaterials=function(){var t="";t+="-- Materials --\n";for(var e=0;this.materialCount>e;e++)t+=this.materials[e].dump();return t+="\n"},i.prototype._dumpBones=function(){var t="";t+="-- Bones --\n";for(var e=0;this.boneCount>e;e++)t+=this.bones[e].dump();return t+="\n"},i.prototype._dumpIKs=function(){var t="";t+="-- IKs --\n";for(var e=0;this.ikCount>e;e++)t+=this.iks[e].dump();return t+="\n"},i.prototype._dumpFaces=function(){var t="";t+="-- Faces --\n";for(var e=0;this.faceCount>e;e++)t+=this.faces[e].dump();return t+="\n"},i.prototype._dumpFaceDisplays=function(){var t="";t+="-- Face Displays --\n";for(var e=0;this.faceDisplayCount>e;e++)t+=this.faceDisplays[e].dump();return t+="\n"},i.prototype._dumpBoneFrameNames=function(){var t="";t+="-- Bone Frame Names --\n";for(var e=0;this.boneFrameNameCount>e;e++)t+=this.boneFrameNames[e].dump();return t+="\n"},i.prototype._dumpBoneDisplays=function(){var t="";t+="-- Bone Displays --\n";for(var e=0;this.boneDisplayCount>e;e++)t+=this.boneDisplays[e].dump();return t+="\n"},i.prototype._dumpEnglishBoneNames=function(){var t="";t+="-- Bone Names(English) --\n";for(var e=0;this.boneCount>e;e++)t+=this.englishBoneNames[e].dump();return t+="\n"},i.prototype._dumpEnglishFaceNames=function(){var t="";t+="-- Face Names(English) --\n";for(var e=0;this.faceCount-1>e;e++)t+=this.englishFaceNames[e].dump();return t+="\n"},i.prototype._dumpEnglishBoneFrameNames=function(){var t="";t+="-- Bone Frame Names(English) --\n";for(var e=0;this.boneFrameNameCount>e;e++)t+=this.englishBoneFrameNames[e].dump();return t+="\n"},i.prototype._dumpToonTextures=function(){var t="";t+="-- Toon Textures --\n";for(var e=0;this.toonTextureCount>e;e++)t+=this.toonTextures[e].dump();return t+="\n"},i.prototype._dumpRigidBodies=function(){var t="";t+="-- Rigid Bodies --\n";for(var e=0;this.rigidBodyCount>e;e++)t+=this.rigidBodies[e].dump();return t+="\n"},i.prototype._dumpJoints=function(){var t="";t+="-- Joints --\n";for(var e=0;this.jointCount>e;e++)t+=this.joints[e].dump();return t+="\n"},r.prototype.valid=function(){return"Pmd"==this.magic},r.prototype.dump=function(){var t="";return t+="magic: "+this.magic+"\n",t+="version: "+this.version+"\n",t+="model_name: "+this.modelName+"\n",t+="comment: "+this.comment+"\n"},o.prototype.setup=function(){this.boneWeightFloat1=this.boneWeight/100,this.boneWeightFloat2=(100-this.boneWeight)/100},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="position: "+this.position+"\n",t+="normal: "+this.normal+"\n",t+="uv: "+this.uv+"\n",t+="boneIndices: "+this.boneIndices+"\n",t+="boneWeight: "+this.boneWeight+"\n",t+="edgeFlag: "+this.edgeFlag+"\n"},o.prototype.toRight=function(){this.position[2]=-this.position[2],this.normal[2]=-this.normal[2]},n.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n"},s.prototype.convertedFileName=function(){var t,e=this.fileName.replace(".tga",".png");return(t=e.lastIndexOf("*"))<0||(e=e.substring(0,t)),e},s.prototype.hasSphereTexture=function(){return this.fileName.lastIndexOf(".sph")>=0||this.fileName.lastIndexOf(".spa")>=0},s.prototype.isSphereMapAddition=function(){var t=this.fileName;return t.lastIndexOf(".spa")>=0},s.prototype.sphereMapFileName=function(){var t,e=this.fileName;return(t=e.lastIndexOf("*"))<0||(e=e.slice(t+1)),(t=e.lastIndexOf("+"))<0||(e=e.slice(t+1)),e},s.prototype.hasToon=function(){return this.tuneIndex<10},s.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="color: "+this.color+"\n",t+="specularity: "+this.specularity+"\n",t+="specularColor: "+this.specularColor+"\n",t+="mirrorColor: "+this.mirrorColor+"\n",t+="tuneIndex: "+this.tuneIndex+"\n",t+="edgeFlag: "+this.edgeFlag+"\n",t+="vertexCount: "+this.vertexCount+"\n",t+="fileName: "+this.fileName+"\n"},a.prototype.isKnee=function(){return this.name.indexOf("0x820xd00x820xb4")>=0},a.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="parentIndex: "+this.parentIndex+"\n",t+="tailIndex: "+this.tailIndex+"\n",t+="type: "+this.type+"\n",t+="ikIndex: "+this.ikIndex+"\n",t+="position: "+this.position+"\n"},a.prototype.toRight=function(){this.position[2]=-this.position[2]},h.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n",t+="targetBoneIndex: "+this.targetBoneIndex+"\n",t+="chainLength: "+this.chainLength+"\n",t+="iteration: "+this.iteration+"\n",t+="limitation: "+this.limitation+"\n",t+="childBoneIndices: "+this.childBoneIndices+"\n"},p.prototype.dump=function(){var t="";t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="vertexCount: "+this.vertexCount+"\n",t+="type: "+this.type+"\n";for(var e=0;this.vertices.length>e;e++)t+=this.vertices[e].dump();return t},p.prototype.toRight=function(){for(var t=0;this.vertices.length>t;t++)this.vertices[t].toRight()},u.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n",t+="position: "+this.position+"\n"},u.prototype.toRight=function(){this.position[2]=-this.position[2]},f.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n"},l.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},c.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n",t+="frameIndex: "+this.frameIndex+"\n"},m.prototype.dump=function(){var t="";return t+="compatibility: "+this.compatibility+"\n",t+="modelName:     "+this.modelName+"\n",t+="comment: "+this.comment+"\n"},_.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},d.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},y.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},v.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="fileName: "+this.fileName+"\n"},g.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="boneIndex: "+this.boneIndex+"\n",t+="groupIndex: "+this.groupIndex+"\n",t+="groupTarget: "+this.groupTarget+"\n",t+="shapeType: "+this.shapeType+"\n",t+="width: "+this.width+"\n",t+="height: "+this.height+"\n",t+="depth: "+this.depth+"\n",t+="position: "+this.position+"\n",t+="rotation: "+this.rotation+"\n",t+="weight: "+this.weight+"\n",t+="positionDim: "+this.positionDim+"\n",t+="rotationDim: "+this.rotationDim+"\n",t+="recoil: "+this.recoil+"\n",t+="friction: "+this.friction+"\n",t+="type: "+this.type+"\n"},g.prototype.toRight=function(){this.position[2]=-this.position[2],this.rotation[0]=-this.rotation[0],this.rotation[1]=-this.rotation[1]},T.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="rigidBody1: "+this.rigidBody1+"\n",t+="rigidBody2: "+this.rigidBody2+"\n",t+="position: "+this.position+"\n",t+="rotation: "+this.rotation+"\n",t+="translationLimitation1: "+this.translationLimitation1+"\n",t+="translationLimitation2: "+this.translationLimitation2+"\n",t+="rotationLimitation1: "+this.rotationLimitation1+"\n",t+="rotationLimitation2: "+this.rotationLimitation2+"\n",t+="springPosition: "+this.springPosition+"\n",t+="springRotation: "+this.springRotation+"\n"},T.prototype.toRight=function(){this.position[2]=-this.position[2],this.rotation[0]=-this.rotation[0],this.rotation[1]=-this.rotation[1]},A.prototype.load=function(t){this.pmd.images.length=0,this.pmd.toonImages.length=0,this.pmd.sphereImages.length=0,this.errorImageNum=0,this.loadedImageNum=0,this.noImageNum=0;for(var e=0;this.pmd.materialCount>e;e++){var i=this.pmd.materials[e].convertedFileName();if(""!=i&&i.indexOf(".spa")<0&&i.indexOf(".sph")<0){var r=this;this.pmd.images[e]=new Image,this.pmd.images[e].onerror=function(e){r.errorImageNum++,r._checkDone(t)},this.pmd.images[e].onload=function(e){r.loadedImageNum++,r._checkDone(t)},this.pmd.images[e].src=this.baseURL+"/"+i}else this.pmd.images[e]=this._generatePixelImage(),this.noImageNum++,this._checkDone(t)}for(var e=0;this.pmd.toonTextureCount>e;e++){var i=this.pmd.toonTextures[e].fileName;if(""!=i&&i.indexOf(".spa")<0&&i.indexOf(".sph")<0){var r=this;this.pmd.toonImages[e]=new Image,this.pmd.toonImages[e].onerror=function(e){r.errorImageNum++,r._checkDone(t)},this.pmd.toonImages[e].onload=function(e){r.loadedImageNum++,r._checkDone(t)},this.pmd.toonImages[e].src=this.baseURL+"/"+i}else this.pmd.toonImages[e]=this._generatePixelImage(),this.noImageNum++,this._checkDone(t)}for(var e=0;this.pmd.materialCount>e;e++)if(this.pmd.materials[e].hasSphereTexture()){var i=this.pmd.materials[e].sphereMapFileName(),r=this;this.pmd.sphereImages[e]=new Image,this.pmd.sphereImages[e].onerror=function(e){r.errorImageNum++,r._checkDone(t)},this.pmd.sphereImages[e].onload=function(e){r.loadedImageNum++,r._checkDone(t)},this.pmd.sphereImages[e].src=this.baseURL+"/"+i}else this.pmd.sphereImages[e]=this._generatePixelImage(),this.noImageNum++,this._checkDone(t)},A.prototype._generatePixelImage=function(){var t=document.createElement("canvas");t.width=1,t.height=1;var e=t.getContext("2d");return e.fillStyle="rgb(255, 255, 255)",e.fillRect(0,0,1,1),t},A.prototype._checkDone=function(t){2*this.pmd.materialCount+this.pmd.toonTextureCount>this.loadedImageNum+this.noImageNum+this.errorImageNum||t(this.pmd)},t.exports={PMD:i,PMDHeader:r,PMDVertex:o,PMDVertexIndex:n,PMDMaterial:s,PMDBone:a,PMDIK:h,PMDFace:p,PMDFaceVertex:u,PMDFaceDisplay:f,PMDBoneFrameName:l,PMDBoneDisplay:c,PMDEnglishHeader:m,PMDEnglishBoneName:_,PMDEnglishFaceName:d,PMDEnglishBoneFrameName:y,PMDToonTexture:v,PMDRigidBody:g,PMDJoint:T}},51:function(t,e,i){"use strict";function r(){this.header=null,this.motionCount=null,this.faceCount=null,this.cameraCount=null,this.lightCount=null,this.motions=[],this.faces=[],this.cameras=[],this.lights=[],this.frame=0,this.orderedMotions=[],this.orderedFaces=[],this.orderedCameras=[],this.orderedLights=[],this.cameraIndex=-1,this.lightIndex=-1,this.stepMotions=[],this.stepFaces=[],this.stepCamera={location:[0,0,0],rotation:[0,0,0],length:0,angle:0,available:!0},this.stepLight={color:[0,0,0],location:[0,0,0],available:!0}}function o(){this.magic=null,this.modelName=null}function n(t){this.id=t,this.boneName=null,this.frameNum=null,this.location=null,this.rotation=null,this.interpolation=null}function s(t){this.id=t,this.name=null,this.frameNum=null,this.weight=null}function a(t){this.id=t,this.frameNum=null,this.length=null,this.location=null,this.rotation=null,this.interpolation=null,this.angle=null,this.perspective=null}function h(t){this.id=t,this.frameNum=null,this.color=null,this.location=null}var p=i(17);r.prototype.Object=Object,r.prototype.Math=Math,r.prototype.vec3=p.vec3,r.prototype.quat4=p.quat4,r.prototype.valid=function(){return this.header.valid()},r.prototype.supply=function(){for(var t=0;this.motionCount>t;t++)this.motions[t].supply();for(var t=0;this.faceCount>t;t++)this.faces[t].supply();for(var t=0;this.cameraCount>t;t++)this.cameras[t].supply();for(var t=0;this.lightCount>t;t++)this.lights[t].supply()},r.prototype.clone=function(){var t=new r;t.motionCount=this.motionCount,t.faceCount=this.faceCount,t.cameraCount=this.cameraCount,t.lightCount=this.lightCount;for(var e=0;this.motionCount>e;e++)t.motions[e]=this.motions[e];for(var e=0;this.faceCount>e;e++)t.faces[e]=this.faces[e];for(var e=0;this.cameraCount>e;e++)t.cameras[e]=this.cameras[e];for(var e=0;this.lightCount>e;e++)t.lights[e]=this.lights[e];return t},r.prototype.setup=function(t){this.frame=0,this.cameraIndex=-1,this.lightIndex=-1,t&&(this._setupMotions(t),this._setupFaces(t)),this._setupCameras(),this._setupLights(),this.step(1)},r.prototype._setupMotions=function(t){for(var e={},i=0;this.motionCount>i;i++){var r=this.motions[i];void 0!==t.bonesHash[r.boneName]&&(void 0===e[r.boneName]&&(e[r.boneName]={},e[r.boneName].motions=[],e[r.boneName].index=-1),e[r.boneName].motions.push(r))}for(var o in e)e[o].motions.sort(function(t,e){return t.frameNum-e.frameNum});this.orderedMotions.length=0;for(var n=this.Object.keys(e),i=0;n.length>i;i++)this.orderedMotions[i]=e[n[i]];this.stepMotions.length=0;for(var i=0;t.boneCount>i;i++){var s={};s.location=[0,0,0],s.rotation=[0,0,0,1],this._clearVec3(s.location),this._clearQuat4(s.rotation),this.stepMotions[i]=s}for(var a=(t.getBoneNames(),0),i=0;t.bones.length>i;i++){var h=t.bones[i];h.motionIndex=n.indexOf(h.name),h.motionIndex==-1&&(h.motionIndex=n.length+a,a++)}},r.prototype._setupFaces=function(t){for(var e={},i=0;this.faceCount>i;i++){var r=this.faces[i];void 0!==t.facesHash[r.name]&&(void 0===e[r.name]&&(e[r.name]={},e[r.name].faces=[],e[r.name].index=-1),e[r.name].faces.push(r))}for(var o in e)e[o].faces.sort(function(t,e){return t.frameNum-e.frameNum});this.orderedFaces.length=0;for(var n=this.Object.keys(e),i=0;n.length>i;i++)this.orderedFaces[i]=e[n[i]];this.stepFaces.length=0;for(var i=0;t.faceCount>i;i++){var s={};s.weight=0,s.available=!0,this.stepFaces[i]=s}for(var a=(t.getFaceNames(),0),i=0;t.faces.length>i;i++){var h=t.faces[i];h.motionIndex=n.indexOf(h.name),h.motionIndex==-1&&(h.motionIndex=n.length+a,this.stepFaces[h.motionIndex].available=!1,a++)}},r.prototype._setupCameras=function(){this.orderedCameras.length=0;for(var t=0;this.cameraCount>t;t++)this.orderedCameras[t]=this.cameras[t];this.orderedCameras.sort(function(t,e){return t.frameNum-e.frameNum})},r.prototype._setupLights=function(){this.orderedLights.length=0;for(var t=0;this.lightCount>t;t++)this.orderedLights[t]={},this.orderedLights[t].light=this.lights[t];this.orderedLights.sort(function(t,e){return t.light.frameNum-e.light.frameNum})},r.prototype.step=function(t){this._stepMotion(),this._stepFace(),this._stepCamera(),this._stepLight(),this.frame+=t},r.prototype._stepMotion=function(){for(var t=0;this.orderedMotions.length>t;t++)for(var e=this.orderedMotions[t];e.motions.length>e.index+1&&this.frame>=e.motions[e.index+1].frameNum;)e.index++},r.prototype._stepFace=function(){for(var t=0;this.orderedFaces.length>t;t++)for(var e=this.orderedFaces[t];e.faces.length>e.index+1&&this.frame>=e.faces[e.index+1].frameNum;)e.index++},r.prototype._stepCamera=function(){for(;this.cameras.length>this.cameraIndex+1&&this.frame>=this.orderedCameras[this.cameraIndex+1].frameNum;)this.cameraIndex++},r.prototype._stepLight=function(){for(;this.lights.length>this.lightIndex+1&&this.frame>=this.orderedLights[this.lightIndex+1].light.frameNum;)this.lightIndex++},r.prototype.merge=function(t){this.motionCount+=t.motionCount,this.faceCount+=t.faceCount,this.cameraCount+=t.cameraCount,this.lightCount+=t.lightCount;for(var e=0;t.motionCount>e;e++)this.motions.push(t.motions[e]);for(var e=0;t.faceCount>e;e++)this.faces.push(t.faces[e]);for(var e=0;t.cameraCount>e;e++)this.cameras.push(t.cameras[e]);for(var e=0;t.lightCount>e;e++)this.lights.push(t.lights[e])},r.prototype.addOffset=function(t){for(var e=0;this.motionCount>e;e++)this.motions[e].frameNum+=t;for(var e=0;this.faceCount>e;e++)this.faces[e].frameNum+=t;for(var e=0;this.cameraCount>e;e++)this.cameras[e].frameNum+=t;for(var e=0;this.lightCount>e;e++)this.lights[e].frameNum+=t},r.prototype.loadMotion=function(){for(var t=0;this.orderedMotions.length>t;t++){var e=this.orderedMotions[t];if(e.index!=-1){var i=e.motions[e.index],r=e.motions[e.index+1],o=this.stepMotions[t];if(i.frameNum!=this.frame&&void 0!==r&&2<r.frameNum-i.frameNum){var n=r.frameNum-i.frameNum,s=this.frame-i.frameNum,a=s/n;this._slerpQuat4(i.rotation,r.rotation,a,o.rotation),this._lerpVec3(i.location,r.location,a,o.location)}else this._setVec3(i.location,o.location),this._setQuat4(i.rotation,o.rotation)}}for(var t=this.orderedMotions.length;this.stepMotions.length>t;t++){var h=this.stepMotions[t];this._clearVec3(h.location),this._clearQuat4(h.rotation)}},r.prototype.loadFace=function(){for(var t=0;this.orderedFaces.length>t;t++){var e=this.orderedFaces[t];if(e.index!=-1){var i=e.faces[e.index],r=e.faces[e.index+1],o=this.stepFaces[t];if(i.frameNum!=this.frameNum&&void 0!==r&&2<r.frameNum-i.frameNum){var n=r.frameNum-i.frameNum,s=this.frame-i.frameNum,a=s/n;o.weight=this._lerp(i.weight,r.weight,a)}else o.weight=i.weight}}},r.prototype.loadCamera=function(){var t=this.orderedCameras,e=this.cameraIndex;if(this.stepCamera.available=!1,e!=-1){this.stepCamera.available=!0;var i=t[e],r=t[e+1];if(i.frameNum!=this.frame&&void 0!==r&&2<r.frameNum-i.frameNum){var o=r.frameNum-i.frameNum,n=this.frame-i.frameNum,s=n/o;this._lerpVec3(i.location,r.location,s,this.stepCamera.location),this._lerpVec3(i.rotation,r.rotation,s,this.stepCamera.rotation),this.stepCamera.length=this._lerp(i.length,r.length,s),this.stepCamera.angle=this._lerp(i.angle,r.angle,s)}else this._setVec3(i.location,this.stepCamera.location),this._setVec3(i.rotation,this.stepCamera.rotation),this.stepCamera.length=i.length,this.stepCamera.angle=i.angle}},r.prototype.loadLight=function(){var t=this.orderedLights,e=this.lightIndex;if(this.stepLight.available=!1,e!=-1){var i=t[e].light;this.stepLight.available=!0,this._setVec3(i.color,this.stepLight.color),this._setVec3(i.location,this.stepLight.location)}},r.prototype._setVec3=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2]},r.prototype._setQuat4=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},r.prototype._clearVec3=function(t){t[0]=0,t[1]=0,t[2]=0},r.prototype._clearQuat4=function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1},r.prototype._lerp=function(t,e,i){return t*(1-i)+e*i},r.prototype._lerpVec3=function(t,e,i,r){r[0]=this._lerp(t[0],e[0],i),r[1]=this._lerp(t[1],e[1],i),r[2]=this._lerp(t[2],e[2],i)},r.prototype._slerpQuat4=function(t,e,i,r){var o=t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3];if(0>o?(r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=-e[3],o=-o):(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]),this.Math.abs(o)>=1)return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r;var n=this.Math.acos(o),s=this.Math.sqrt(1-o*o);if(this.Math.abs(s)<.001)return r[0]=.5*(t[0]+e[0]),r[1]=.5*(t[1]+e[1]),r[2]=.5*(t[2]+e[2]),r[3]=.5*(t[3]+e[3]),r;var a=this.Math.sin((1-i)*n)/s,h=this.Math.sin(i*n)/s;return r[0]=t[0]*a+r[0]*h,r[1]=t[1]*a+r[1]*h,r[2]=t[2]*a+r[2]*h,r[3]=t[3]*a+r[3]*h,r},p.vec3.rotateX=function(t,e,i){var r=p.mat4.rotateX(p.mat4.identity(p.mat4.create()),e);return p.mat4.multiplyVec3(r,t,i)},p.vec3.rotateY=function(t,e,i){var r=p.mat4.rotateY(p.mat4.identity(p.mat4.create()),e);return p.mat4.multiplyVec3(r,t,i)},p.vec3.rotateZ=function(t,e,i){var r=p.mat4.rotateZ(p.mat4.identity(p.mat4.create()),e);return p.mat4.multiplyVec3(r,t,i)},r.prototype.getBoneMotion=function(t){return this.stepMotions[t.motionIndex]},r.prototype.getFace=function(t){return this.stepFaces[t.motionIndex]},r.prototype.getCamera=function(){return this.stepCamera},r.prototype.getLight=function(){return this.stepLight},r.prototype.getCalculatedCameraParams=function(t,e,i){var r=0,o=this.getCamera();e[0]=o.location[0],e[1]=o.location[1]+r,e[2]=o.location[2],t[0]=0,t[1]=0+r,t[2]=o.length,i[0]=0,i[1]=1,i[2]=0,this.vec3.rotateX(t,o.rotation[0],t),this.vec3.rotateY(t,o.rotation[1],t),this.vec3.rotateZ(t,o.rotation[2],t),this.vec3.add(t,o.location,t),this.vec3.rotateX(i,o.rotation[0],i),this.vec3.rotateY(i,o.rotation[1],i),this.vec3.rotateZ(i,o.rotation[2],i)},r.prototype.dump=function(){var t="";return t+="motionCount: "+this.motionCount+"\n",t+="faceCount: "+this.faceCount+"\n",t+="cameraCount: "+this.cameraCount+"\n",t+="lightCount: "+this.lightCount+"\n",t+=this._dumpMotions(),t+=this._dumpFaces(),t+=this._dumpCameras(),t+=this._dumpLights()},r.prototype._dumpMotions=function(){var t="";t+="-- Motions --\n";for(var e=0;this.motionCount>e;e++)t+=this.motions[e].dump();return t+="\n"},r.prototype._dumpFaces=function(){var t="";t+="-- Faces --\n";for(var e=0;this.faceCount>e;e++)t+=this.faces[e].dump();return t+="\n"},r.prototype._dumpCameras=function(){var t="";t+="-- Cameras --\n";for(var e=0;this.cameraCount>e;e++)t+=this.cameras[e].dump();return t+="\n"},r.prototype._dumpLights=function(){var t="";t+="-- Lights --\n";for(var e=0;this.lightCount>e;e++)t+=this.lights[e].dump();return t+="\n"},o.prototype.valid=function(){return"Vocaloid Motion Data 0002"==this.magic},o.prototype.dump=function(){var t="";return t+="magic: "+this.magic+"\n",t+="modelName: "+this.modelName+"\n"},n.prototype.supply=function(){this.frameNum*=2},n.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="boneName: "+this.boneName+"\n",t+="frameNum: "+this.frameNum+"\n",t+="location: "+this.location+"\n",t+="rotation: "+this.rotation+"\n",t+="interpolation: "+this.interpolation+"\n"},s.prototype.supply=function(){this.frameNum*=2},s.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="frameNum: "+this.frameNum+"\n",t+="weight: "+this.weight+"\n"},a.prototype.supply=function(){this.frameNum*=2},a.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="frameNum: "+this.frameNum+"\n",t+="length: "+this.length+"\n",t+="location: "+this.location+"\n",t+="rotation: "+this.rotation+"\n",t+="interpolation: "+this.interpolation+"\n",t+="angle: "+this.angle+"\n",t+="perspective: "+this.perspective+"\n"},h.prototype.supply=function(){this.frameNum*=2},h.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="frameNum: "+this.frameNum+"\n",t+="color: "+this.color+"\n",t+="location: "+this.location+"\n"},t.exports={VMD:r,VMDLight:h,VMDHeader:o,VMDMotion:n,VMDFace:s,VMDCamera:a}},52:function(t,e,i){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t){this.uint8=new Uint8Array(t),this.offset=0}var n=i(129),s=r(n);o.prototype.Math=Math,o.prototype.parse=function(){return{}},o.prototype._parseObject=function(t,e){for(var i in e)t[i]=this._getValue(e[i],this.offset),this.offset+=this._sizeof(e[i])},o.prototype._getValue=function(t,e){return void 0===t.isArray?this._getValueScalar(t,e):this._getValueArray(t,e)},o.prototype._getValueScalar=function(t,e){switch(t.type){case"char":return this._getChars(e,1);case"strings":return this._getStrings(e,1);case"uint8":return this._getUint8(e);case"uint16":return this._getUint16(e);case"uint32":return this._getUint32(e);case"float":return this._getFloat(e);default:throw"error: undefined type"+t}},o.prototype._getValueArray=function(t,e){if("char"==t.type)return this._getChars(e,t.size);if("strings"==t.type)return this._getStrings(e,t.size);for(var i=[],r=this._sizeofScalar(t),o=0;t.size>o;o++)i[o]=this._getValueScalar(t,e),e+=r;return i},o.prototype._sizeof=function(t){return void 0===t.isArray?this._sizeofScalar(t):this._sizeofArray(t)},o.prototype._sizeofScalar=function(t){switch(t.type){case"char":return 1;case"strings":return 1;case"uint8":return 1;case"uint16":return 2;case"uint32":return 4;case"float":return 4;default:throw"error: undefined type "+t+" "+t.type}},o.prototype._sizeofArray=function(t){return this._sizeofScalar(t)*t.size},o.prototype._sizeofObject=function(t){var e=0;for(var i in t)e+=this._sizeof(t[i]);return e},o.prototype._getUint8=function(t){return this.uint8[t]},o.prototype._getUint16=function(t){return this._getValueWithReverseByteOrder(t,2)},o.prototype._getUint32=function(t){return this._getValueWithReverseByteOrder(t,4)},o.prototype._getFloat=function(t){return this._toBinary32(this._getValueWithReverseByteOrder(t,4))},o.prototype._getValueWithReverseByteOrder=function(t,e){for(var i=0,r=0;e>r;r++)i=i<<8|this.uint8[t+e-r-1];return i},o.prototype._toBinary32=function(t){var e=t>>31&1,i=t>>23&255,r=8388607&t;if(0==i&&0==r)return 0;if(255==i&&0==r)return 1/0;if(255==i&&0!=r)return NaN;var o=1;0==i&&0!=r&&(i=1,o=0);for(var n=0;23>n;n++)r>>22-n&1&&(o+=this.Math.pow(2,-(n+1)));return o*=this.Math.pow(2,i-127),e&&(o=-o),o},o.prototype._getChars=function(t,e){for(var i="",r=0;e>r;r++){var o=t+r;if(0==this.uint8[o])break;i+=String.fromCharCode(this.uint8[o])}return i},o.prototype._getStrings=function(t,e){for(var i="",r=0;e>r;r++){var o=t+r;if(0==this.uint8[o])break;i+=(0,s.default)(16,this.uint8[o],2)}return i},o.prototype.dump=function(){for(var t=this.uint8,e=0,i=t.length;i>0;)e++,i=i/16|0;for(var r="",o="",n=0;t.length>n;n++)n%16==0&&(r+=(0,s.default)(16,n,e),r+=" "),r+=(0,s.default)(16,t[n],2),r+=" ",o+=32>t[n]||t[n]>126?".":String.fromCharCode(t[n]),n%16==15&&(r+="  ",r+=o,r+="\n",o="");return r},t.exports=o},124:function(t,e,i){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t){this.parent=h.default,this.parent.call(this,t),this.englishCompatibility=!1}var n=i(29),s=r(n),a=i(52),h=r(a),p=i(50);(0,s.default)(o,h.default),o.prototype._HEADER_STRUCTURE={magic:{type:"char",isArray:!0,size:3},version:{type:"float"},modelName:{type:"char",isArray:!0,size:20},comment:{type:"char",isArray:!0,size:256}},o.prototype._VERTICES_STRUCTURE={count:{type:"uint32"},vertices:{type:"object",isArray:!0,size:"count"}},o.prototype._VERTEX_STRUCTURE={position:{type:"float",isArray:!0,size:3},normal:{type:"float",isArray:!0,size:3},uv:{type:"float",isArray:!0,size:2},boneIndices:{type:"uint16",isArray:!0,size:2},boneWeight:{type:"uint8"},edgeFlag:{type:"uint8"}},o.prototype._VERTEX_INDICES_STRUCTURE={count:{type:"uint32"},indices:{type:"object",isArray:!0,size:"count"}},o.prototype._VERTEX_INDEX_STRUCTURE={index:{type:"uint16"}},o.prototype._MATERIALS_STRUCTURE={count:{type:"uint32"},materials:{type:"object",isArray:!0,size:"count"}},o.prototype._MATERIAL_STRUCTURE={color:{type:"float",isArray:!0,size:4},specularity:{type:"float"},specularColor:{type:"float",isArray:!0,size:3},mirrorColor:{type:"float",isArray:!0,size:3},tuneIndex:{type:"uint8"},edgeFlag:{type:"uint8"},vertexCount:{type:"uint32"},fileName:{type:"char",isArray:!0,size:20}},o.prototype._BONES_STRUCTURE={count:{type:"uint16"},bones:{type:"object",isArray:!0,size:"count"}},o.prototype._BONE_STRUCTURE={name:{type:"strings",isArray:!0,size:20},parentIndex:{type:"uint16"},tailIndex:{type:"uint16"},type:{type:"uint8"},ikIndex:{type:"uint16"},position:{type:"float",isArray:!0,size:3}},o.prototype._IKS_STRUCTURE={count:{type:"uint16"},iks:{type:"object",isArray:!0,size:"count"}},o.prototype._IK_STRUCTURE={index:{type:"uint16"},targetBoneIndex:{type:"uint16"},chainLength:{type:"uint8"},iteration:{type:"uint16"},limitation:{type:"float"},childBoneIndices:{type:"uint16",isArray:!0,size:"chainLength"}},o.prototype._FACES_STRUCTURE={count:{type:"uint16"},faces:{type:"object",isArray:!0,size:"count"}},o.prototype._FACE_STRUCTURE={name:{type:"strings",isArray:!0,size:20},vertexCount:{type:"uint32"},type:{type:"uint8"},vertices:{type:"object",isArray:!0,size:"vertexCount"}},o.prototype._FACE_VERTEX_STRUCTURE={index:{type:"uint32"},position:{type:"float",isArray:!0,size:3}},o.prototype._FACE_DISPLAYS_STRUCTURE={count:{type:"uint8"},indices:{type:"object",isArray:!0,size:"count"}},o.prototype._FACE_DISPLAY_STRUCTURE={index:{type:"uint16"}},o.prototype._BONE_FRAME_NAMES_STRUCTURE={count:{type:"uint8"},names:{type:"object",isArray:!0,size:"count"}},o.prototype._BONE_FRAME_NAME_STRUCTURE={name:{type:"strings",isArray:!0,size:50}},o.prototype._BONE_DISPLAYS_STRUCTURE={count:{type:"uint32"},displays:{type:"object",isArray:!0,size:"count"}},o.prototype._BONE_DISPLAY_STRUCTURE={index:{type:"uint16"},frameIndex:{type:"uint8"}},o.prototype._ENGLISH_HEADER_STRUCTURE={compatibility:{type:"uint8"},modelName:{type:"char",isArray:!0,size:20},comment:{type:"char",isArray:!0,size:256}},o.prototype._ENGLISH_BONE_NAME_STRUCTURE={name:{type:"char",isArray:!0,size:20}},o.prototype._ENGLISH_FACE_NAME_STRUCTURE={name:{type:"char",isArray:!0,size:20}},o.prototype._ENGLISH_BONE_FRAME_NAME_STRUCTURE={name:{type:"char",isArray:!0,size:50}},o.prototype._TOON_TEXTURE_STRUCTURE={fileName:{type:"char",isArray:!0,size:100}},o.prototype._RIGID_BODIES_STRUCTURE={count:{type:"uint32"},bodies:{type:"object",isArray:!0,size:"count"}},o.prototype._RIGID_BODY_STRUCTURE={name:{type:"strings",isArray:!0,size:20},boneIndex:{type:"uint16"},groupIndex:{type:"uint8"},groupTarget:{type:"uint16"},shapeType:{type:"uint8"},width:{type:"float"},height:{type:"float"},depth:{type:"float"},position:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:3},weight:{type:"float"},positionDim:{type:"float"},rotationDim:{type:"float"},recoil:{type:"float"},friction:{type:"float"},type:{type:"uint8"}},o.prototype._JOINTS_STRUCTURE={count:{type:"uint32"},joints:{type:"object",isArray:!0,size:"count"}},o.prototype._JOINT_STRUCTURE={name:{type:"strings",isArray:!0,size:20},rigidBody1:{type:"uint32"},rigidBody2:{type:"uint32"},position:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:3},translationLimitation1:{type:"float",isArray:!0,size:3},translationLimitation2:{type:"float",isArray:!0,size:3},rotationLimitation1:{type:"float",isArray:!0,size:3},rotationLimitation2:{type:"float",isArray:!0,size:3},springPosition:{type:"float",isArray:!0,size:3},springRotation:{type:"float",isArray:!0,size:3}},o.prototype.parse=function(){this.offset=0;var t=new p.PMD;return this._parseHeader(t),this._parseVertices(t),this._parseVertexIndices(t),this._parseMaterials(t),this._parseBones(t),this._parseIKs(t),this._parseFaces(t),this._parseFaceDisplays(t),this._parseBoneFrameNames(t),this._parseBoneDisplays(t),this._parseEnglishHeader(t),this.englishCompatibility&&(this._parseEnglishBoneNames(t),this._parseEnglishFaceNames(t),this._parseEnglishBoneFrameNames(t)),this._parseToonTextures(t),this._parseRigidBodies(t),this._parseJoints(t),t},o.prototype.valid=function(){var t=this.offset;this.offset=0;var e=new p.PMD;return this._parseHeader(e),this.offset=t,e.valid()},o.prototype._parseHeader=function(t){var e=this._HEADER_STRUCTURE;t.header=new p.PMDHeader,this._parseObject(t.header,e)},o.prototype._parseVertices=function(t){var e=this._VERTICES_STRUCTURE;t.vertexCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.vertices.length=0;for(var i=0;t.vertexCount>i;i++)this._parseVertex(t,i)},o.prototype._parseVertex=function(t,e){var i=this._VERTEX_STRUCTURE,r=new p.PMDVertex(e);this._parseObject(r,i),t.vertices[e]=r},o.prototype._parseVertexIndices=function(t){var e=this._VERTEX_INDICES_STRUCTURE;t.vertexIndexCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.vertexIndices.length=0;for(var i=0;t.vertexIndexCount>i;i++)this._parseVertexIndex(t,i)},o.prototype._parseVertexIndex=function(t,e){var i=this._VERTEX_INDEX_STRUCTURE,r=new p.PMDVertexIndex(e);
this._parseObject(r,i),t.vertexIndices[e]=r},o.prototype._parseMaterials=function(t){var e=this._MATERIALS_STRUCTURE;t.materialCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.materials.length=0;for(var i=0;t.materialCount>i;i++)this._parseMaterial(t,i)},o.prototype._parseMaterial=function(t,e){var i=this._MATERIAL_STRUCTURE,r=new p.PMDMaterial(e);this._parseObject(r,i),t.materials[e]=r},o.prototype._parseBones=function(t){var e=this._BONES_STRUCTURE;t.boneCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.bones.length=0;for(var i=0;t.boneCount>i;i++)this._parseBone(t,i)},o.prototype._parseBone=function(t,e){var i=this._BONE_STRUCTURE,r=new p.PMDBone(e);this._parseObject(r,i),t.bones[e]=r},o.prototype._parseIKs=function(t){var e=this._IKS_STRUCTURE;t.ikCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.iks.length=0;for(var i=0;t.ikCount>i;i++)this._parseIK(t,i)},o.prototype._parseIK=function(t,e){var i=this._IK_STRUCTURE,r=new p.PMDIK(e);for(var o in i)"childBoneIndices"!=o&&(r[o]=this._getValue(i[o],this.offset),this.offset+=this._sizeof(i[o]));r.childBoneIndices=[];for(var n=this._sizeofScalar(i.childBoneIndices),s=0;r.chainLength>s;s++)r.childBoneIndices[s]=this._getValueScalar(i.childBoneIndices,this.offset),this.offset+=n;t.iks[e]=r},o.prototype._parseFaces=function(t){var e=this._FACES_STRUCTURE;t.faceCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.faces.length=0;for(var i=0;t.faceCount>i;i++)this._parseFace(t,i)},o.prototype._parseFace=function(t,e){var i=this._FACE_STRUCTURE,r=new p.PMDFace(e);for(var o in i)"vertices"!=o&&(r[o]=this._getValue(i[o],this.offset),this.offset+=this._sizeof(i[o]));r.vertices=[];for(var n=0;r.vertexCount>n;n++)this._parseFaceVertex(r,n,r.type);t.faces[e]=r},o.prototype._parseFaceVertex=function(t,e,i){var r=this._FACE_VERTEX_STRUCTURE,o=new p.PMDFaceVertex(e,i);this._parseObject(o,r),t.vertices[e]=o},o.prototype._parseFaceDisplays=function(t){var e=this._FACE_DISPLAYS_STRUCTURE;t.faceDisplayCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.faceDisplays.length=0;for(var i=0;t.faceDisplayCount>i;i++)this._parseFaceDisplay(t,i)},o.prototype._parseFaceDisplay=function(t,e){var i=this._FACE_DISPLAY_STRUCTURE,r=new p.PMDFaceDisplay(e);this._parseObject(r,i),t.faceDisplays[e]=r},o.prototype._parseBoneFrameNames=function(t){var e=this._BONE_FRAME_NAMES_STRUCTURE;t.boneFrameNameCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.boneFrameNames.length=0;for(var i=0;t.boneFrameNameCount>i;i++)this._parseBoneFrameName(t,i)},o.prototype._parseBoneFrameName=function(t,e){var i=this._BONE_FRAME_NAME_STRUCTURE,r=new p.PMDBoneFrameName(e);this._parseObject(r,i),t.boneFrameNames[e]=r},o.prototype._parseBoneDisplays=function(t){var e=this._BONE_DISPLAYS_STRUCTURE;t.boneDisplayCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.boneDisplays.length=0;for(var i=0;t.boneDisplayCount>i;i++)this._parseBoneDisplay(t,i)},o.prototype._parseBoneDisplay=function(t,e){var i=this._BONE_DISPLAY_STRUCTURE,r=new p.PMDBoneDisplay(e);this._parseObject(r,i),t.boneDisplays[e]=r},o.prototype._parseEnglishHeader=function(t){var e=this._ENGLISH_HEADER_STRUCTURE;t.englishHeader=new p.PMDEnglishHeader,this._parseObject(t.englishHeader,e),0==t.englishHeader.compatibility?(this.offset-=this._sizeofObject(e),this.offset+=this._sizeof(e.compatibility),this.englishCompatibility=!1):this.englishCompatibility=!0},o.prototype._parseEnglishBoneNames=function(t){var e=this._ENGLISH_BONE_NAME_STRUCTURE;t.englishBoneNames.length=0;for(var i=0;t.boneCount>i;i++){var r=new p.PMDEnglishBoneName(i);this._parseObject(r,e),t.englishBoneNames[i]=r}},o.prototype._parseEnglishFaceNames=function(t){var e=this._ENGLISH_FACE_NAME_STRUCTURE;t.englishFaceNames.length=0;for(var i=0;t.faceCount-1>i;i++){var r=new p.PMDEnglishFaceName(i);this._parseObject(r,e),t.englishFaceNames[i]=r}},o.prototype._parseEnglishBoneFrameNames=function(t){var e=this._ENGLISH_BONE_FRAME_NAME_STRUCTURE;t.englishBoneFrameNames.length=0;for(var i=0;t.boneFrameNameCount>i;i++){var r=new p.PMDEnglishBoneFrameName(i);this._parseObject(r,e),t.englishBoneFrameNames[i]=r}},o.prototype._parseToonTextures=function(t){var e=this._TOON_TEXTURE_STRUCTURE;t.toonTextureCount=10,t.toonTextures.length=0;for(var i=0;t.toonTextureCount>i;i++){var r=new p.PMDToonTexture(i);this._parseObject(r,e),t.toonTextures[i]=r}},o.prototype._parseRigidBodies=function(t){var e=this._RIGID_BODIES_STRUCTURE;t.rigidBodyCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.rigidBodies.length=0;for(var i=0;t.rigidBodyCount>i;i++)this._parseRigidBody(t,i)},o.prototype._parseRigidBody=function(t,e){var i=this._RIGID_BODY_STRUCTURE,r=new p.PMDRigidBody(e);this._parseObject(r,i),t.rigidBodies[e]=r},o.prototype._parseJoints=function(t){var e=this._JOINTS_STRUCTURE;t.jointCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.joints.length=0;for(var i=0;t.jointCount>i;i++)this._parseJoint(t,i)},o.prototype._parseJoint=function(t,e){var i=this._JOINT_STRUCTURE,r=new p.PMDJoint(e);this._parseObject(r,i),t.joints[e]=r},t.exports=o},125:function(t,e,i){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,i){this.layer=t,this.pmd=e,this.view=i,this.vmd=null,this.audio=null,this.vArray=u(e.vertexCount*this._V_ITEM_SIZE),this.vArray1=u(e.vertexCount*this._V_ITEM_SIZE),this.vArray2=u(e.vertexCount*this._V_ITEM_SIZE),this.vmArray=u(e.vertexCount*this._V_ITEM_SIZE),this.veArray=u(e.vertexCount*this._VE_ITEM_SIZE),this.mtArray1=u(e.vertexCount*this._MT_ITEM_SIZE),this.mtArray2=u(e.vertexCount*this._MT_ITEM_SIZE),this.mrArray1=u(e.vertexCount*this._MR_ITEM_SIZE),this.mrArray2=u(e.vertexCount*this._MR_ITEM_SIZE),this.cArray=u(e.vertexCount*this._C_ITEM_SIZE),this.iArray=f(e.vertexIndexCount),this.biArray=u(e.vertexCount*this._BI_ITEM_SIZE),this.bwArray=u(e.vertexCount*this._BW_ITEM_SIZE),this.vnArray=u(e.vertexCount*this._VN_ITEM_SIZE),this.textures=[],this.toonTextures=[],this.sphereTextures=[],this.basePosition=[0,0,0],this.frame=0,this.motions=[],this.originalMotions={},this.posFromBone1=[],this.posFromBone2=[],this.dancing=!1,this.physics=new p.default(this.pmd)}var n=i(17),s=i(128),a=r(s),h=i(49),p=r(h),u=function(t){return new Float32Array(t)},f=function(t){return new Uint16Array(t)};o.prototype.Math=Math,o.prototype.vec3=n.vec3,o.prototype.quat4=n.quat4,o.prototype.mat4=n.mat4,o.prototype._V_ITEM_SIZE=3,o.prototype._C_ITEM_SIZE=2,o.prototype._I_ITEM_SIZE=1,o.prototype._BW_ITEM_SIZE=1,o.prototype._BI_ITEM_SIZE=2,o.prototype._MT_ITEM_SIZE=3,o.prototype._MR_ITEM_SIZE=4,o.prototype._VN_ITEM_SIZE=3,o.prototype._VE_ITEM_SIZE=1,o.prototype.setup=function(){for(var t=0;this.pmd.vertexCount>t;t++){for(var e=0;this._MT_ITEM_SIZE>e;e++)this.mtArray1[t*this._MT_ITEM_SIZE+e]=0,this.mtArray2[t*this._MT_ITEM_SIZE+e]=0;for(var e=0;this._MR_ITEM_SIZE>e;e++)this.mrArray1[t*this._MR_ITEM_SIZE+e]=0,this.mrArray2[t*this._MR_ITEM_SIZE+e]=0}this.layer={},this.layer.pourArrayBuffer=function(){},this.layer.pourElementArrayBuffer=function(){},this._initArrays(),this._initTextures()},o.prototype.setBasePosition=function(t,e,i){this.basePosition[0]=t,this.basePosition[1]=e,this.basePosition[2]=i,this._initMotions2();for(var r=0;this.pmd.boneCount>r;r++)this._getBoneMotion(r);this.physics.resetRigidBodies(this.motions)},o.prototype.setVMD=function(t){this.vmd=t},o.prototype.startDance=function(){this.vmd.setup(this.pmd),this.dancing=!0,this.frame=0,this._initMotions2(),this._moveBone(1),this.physics.resetRigidBodies(this.motions)},o.prototype._initArrays=function(){this._initVertices(),this._initVerticesFromBones(),this._initVertexMorphs(),this._initVertexEdges(),this._initCoordinates(),this._initIndices(),this._initBoneWeights(),this._initBoneIndices(),this._initVertexNormals(),this._initMotions(),this._initMotionArrays()},o.prototype._initVertices=function(){for(var t=0;this.pmd.vertexCount>t;t++)for(var e=this.pmd.vertices[t].position,i=t*this._V_ITEM_SIZE,r=0;this._V_ITEM_SIZE>r;r++)this.vArray[i+r]=e[r]},o.prototype._initVerticesFromBones=function(){for(var t=0;this.pmd.vertexCount>t;t++){for(var e=this.pmd.vertices[t].position,i=this.pmd.vertices[t].boneIndices[0],r=this.pmd.vertices[t].boneIndices[1],o=this.pmd.bones[i],n=this.pmd.bones[r],s=this.vec3.create(),a=this.vec3.create(),h=0;this._V_ITEM_SIZE>h;h++)s[h]=e[h]-o.position[h],a[h]=e[h]-n.position[h];this.posFromBone1.push(s),this.posFromBone2.push(a);for(var p=t*this._V_ITEM_SIZE,h=0;this._V_ITEM_SIZE>h;h++)this.vArray1[p+h]=e[h]-o.position[h],this.vArray2[p+h]=e[h]-n.position[h]}},o.prototype._initVertexMorphs=function(){for(var t=0;this.pmd.vertexCount>t;t++)for(var e=t*this._V_ITEM_SIZE,i=0;this._V_ITEM_SIZE>i;i++)this.vmArray[e+i]=0},o.prototype._initVertexEdges=function(){for(var t=0;this.pmd.vertexCount>t;t++)this.veArray[t]=this.pmd.vertices[t].edgeFlag?0:1},o.prototype._initCoordinates=function(){for(var t=0;this.pmd.vertexCount>t;t++)for(var e=t*this._C_ITEM_SIZE,i=this.pmd.vertices[t].uv,r=0;this._C_ITEM_SIZE>r;r++)this.cArray[e+r]=i[r]},o.prototype._initIndices=function(){for(var t=0;this.pmd.vertexIndexCount>t;t++)this.iArray[t]=this.pmd.vertexIndices[t].index},o.prototype._initBoneWeights=function(){for(var t=0;this.pmd.vertexCount>t;t++)this.bwArray[t]=this.pmd.vertices[t].boneWeight/100},o.prototype._initBoneIndices=function(){for(var t=0;this.pmd.vertexCount>t;t++)for(var e=0;this._BI_ITEM_SIZE>e;e++)this.biArray[t*this._BI_ITEM_SIZE+e]=this.pmd.vertices[t].boneIndices[e]},o.prototype._initVertexNormals=function(){for(var t=0;this.pmd.vertexCount>t;t++)for(var e=this.pmd.vertices[t].normal,i=t*this._VN_ITEM_SIZE,r=0;this._VN_ITEM_SIZE>r;r++)this.vnArray[i+r]=e[r]},o.prototype._initMotionArrays=function(){if(this.view.skinningType==this.view._SKINNING_CPU)return void this._skinning();if(this.view.skinningType==this.view._SKINNING_GPU)return void this._pourVTF();for(var t=0;this.pmd.vertexCount>t;t++){for(var e=this.pmd.vertices[t].boneIndices[0],i=this.pmd.vertices[t].boneIndices[1],r=this._getBoneMotion(e),n=this._getBoneMotion(i),s=t*this._MT_ITEM_SIZE,h=0;this._MT_ITEM_SIZE>h;h++)this.mtArray1[s+h]=r.p[h],this.mtArray2[s+h]=n.p[h];s=t*this._MR_ITEM_SIZE;for(var h=0;this._MR_ITEM_SIZE>h;h++)this.mrArray1[s+h]=r.r[h],this.mrArray2[s+h]=n.r[h]}o.prototype.getVerticals=function(t){var e=[this.vArray1[3*t+0]+this.vmArray[3*t+0]+2*(((this.vArray1[3*t+2]+this.vmArray[3*t+2])*this.mrArray1[4*t+0]-(this.vArray1[3*t+0]+this.vmArray[3*t+0])*this.mrArray1[4*t+2]-(this.vArray1[3*t+1]+this.vmArray[3*t+1])*this.mrArray1[4*t+3])*this.mrArray1[4*t+2]-((this.vArray1[3*t+0]+this.vmArray[3*t+0])*this.mrArray1[4*t+1]-(this.vArray1[3*t+1]+this.vmArray[3*t+1])*this.mrArray1[4*t+0]-(this.vArray1[3*t+2]+this.vmArray[3*t+2])*this.mrArray1[4*t+3])*this.mrArray1[4*t+1])+this.mtArray1[3*t+0],this.vArray1[3*t+1]+this.vmArray[3*t+1]+2*(((this.vArray1[3*t+0]+this.vmArray[3*t+0])*this.mrArray1[4*t+1]-(this.vArray1[3*t+1]+this.vmArray[3*t+1])*this.mrArray1[4*t+0]-(this.vArray1[3*t+2]+this.vmArray[3*t+2])*this.mrArray1[4*t+3])*this.mrArray1[4*t+0]-((this.vArray1[3*t+1]+this.vmArray[3*t+1])*this.mrArray1[4*t+2]-(this.vArray1[3*t+2]+this.vmArray[3*t+2])*this.mrArray1[4*t+1]-(this.vArray1[3*t+0]+this.vmArray[3*t+0])*this.mrArray1[4*t+3])*this.mrArray1[4*t+2])+this.mtArray1[3*t+1],this.vArray1[3*t+2]+this.vmArray[3*t+2]+2*(((this.vArray1[3*t+1]+this.vmArray[3*t+1])*this.mrArray1[4*t+2]-(this.vArray1[3*t+2]+this.vmArray[3*t+2])*this.mrArray1[4*t+1]-(this.vArray1[3*t+0]+this.vmArray[3*t+0])*this.mrArray1[4*t+3])*this.mrArray1[4*t+1]-((this.vArray1[3*t+2]+this.vmArray[3*t+2])*this.mrArray1[4*t+0]-(this.vArray1[3*t+0]+this.vmArray[3*t+0])*this.mrArray1[4*t+2]-(this.vArray1[3*t+1]+this.vmArray[3*t+1])*this.mrArray1[4*t+3])*this.mrArray1[4*t+0])+this.mtArray1[3*t+2]];if(.99>this.bwArray[t]){var i=a.default.arrayAdd([this.vArray2[3*t+0],this.vArray2[3*t+1],this.vArray2[3*t+2]],[this.vmArray[3*t+0],this.vmArray[3*t+1],this.vmArray[3*t+2]]);i=a.default.arrayAdd(a.default.qtransform(i,[this.mrArray2[4*t+0],this.mrArray2[4*t+1],this.mrArray2[4*t+2],this.mrArray2[4*t+3]]),[this.mtArray2[3*t+0],this.mtArray2[3*t+1],this.mtArray2[3*t+2]]),e=a.default.mix(i,e,this.bwArray[t])}return e}.bind(this)},o.prototype._initTextures=function(){return},o.prototype._initMotions=function(){for(var t=0;this.pmd.boneCount>t;t++){this.motions[t]={r:this.quat4.create(),p:this.vec3.create(),done:!1};var e=this.pmd.bones[t],i={};i.location=[0,0,0],i.rotation=[0,0,0,1],this.originalMotions[e.name]=i}},o.prototype._initMotions2=function(){for(var t=0;this.pmd.boneCount>t;t++)if(this.motions[t]){this.quat4.clear(this.motions[t].r),this.vec3.clear(this.motions[t].p),this.motions[t].done=!1;var e=this.pmd.bones[t],i=this.originalMotions[e.name];this.vec3.clear(i.location),this.quat4.clear(i.rotation)}},o.prototype._packTo4Uint8=function(t,e,i){t*=1;var r=0>t?128:0;t=this.Math.abs(t),e[i+0]=r|127&t,e[i+1]=256*t&255,e[i+2]=256*t*256&255,e[i+3]=256*t*256*256&255},o.prototype._pourVTF=function(){for(var t=0;this.pmd.boneCount>t;t++){var e=7*t*4,i=this._getBoneMotion(t);this._packTo4Uint8(i.p[0],this.vtfUint8Array,e+0),this._packTo4Uint8(i.p[1],this.vtfUint8Array,e+4),this._packTo4Uint8(i.p[2],this.vtfUint8Array,e+8),this._packTo4Uint8(i.r[0],this.vtfUint8Array,e+12),this._packTo4Uint8(i.r[1],this.vtfUint8Array,e+16),this._packTo4Uint8(i.r[2],this.vtfUint8Array,e+20),this._packTo4Uint8(i.r[3],this.vtfUint8Array,e+24)}this.layer.pourVTF(this.vtf,this.vtfUint8Array,this.vtfWidth)},o.prototype.skinningOneBone=function(t){if(null===t.id)return null;var e=this._getBoneMotion(t.id),i=t.posFromBone,r=[0,0,0];return this.quat4.multiplyVec3(e.r,i,r),this.vec3.add(r,e.p,r),r},o.prototype._skinning=function(){for(var t=this.vec3.create(),e=this.vec3.create(),i=0;this.pmd.vertexCount>i;i++){var r=this.pmd.vertices[i],o=r.boneWeight,n=r.boneIndices[0],s=this._getBoneMotion(n),a=this.posFromBone1[i];this.quat4.multiplyVec3(s.r,a,t),this.vec3.add(t,s.p,t);var h=i*this._V_ITEM_SIZE;if(o<99){var p=r.boneIndices[1],u=this._getBoneMotion(p),f=this.posFromBone2[i];this.quat4.multiplyVec3(u.r,f,e),this.vec3.add(e,u.p,e);var l=r.boneWeightFloat1,c=r.boneWeightFloat2;this.vArray[h+0]=t[0]*l+e[0]*c,this.vArray[h+1]=t[1]*l+e[1]*c,this.vArray[h+2]=t[2]*l+e[2]*c}else this.vArray[h+0]=t[0],this.vArray[h+1]=t[1],this.vArray[h+2]=t[2]}this.layer.pourArrayBuffer(this.vBuffer,this.vArray,this._V_ITEM_SIZE,this.pmd.vertexCount)},o.prototype._pourArrays=function(){var t=this.layer;t.pourArrayBuffer(this.vBuffer,this.vArray,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vBuffer1,this.vArray1,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vBuffer2,this.vArray2,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vmBuffer,this.vmArray,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.cBuffer,this.cArray,this._C_ITEM_SIZE,this.pmd.vertexCount),t.pourElementArrayBuffer(this.iBuffer,this.iArray,this._I_ITEM_SIZE,this.pmd.vertexIndexCount),t.pourArrayBuffer(this.bwBuffer,this.bwArray,this._BW_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.biBuffer,this.biArray,this._BI_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vnBuffer,this.vnArray,this._VN_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.veBuffer,this.veArray,this._VE_ITEM_SIZE,this.pmd.vertexCount)},o.prototype._bindBuffers=function(){var t=this.layer.gl,e=this.layer.shader;t.bindBuffer(t.ARRAY_BUFFER,this.vBuffer),t.enableVertexAttribArray(e.vertexPositionAttribute),t.vertexAttribPointer(e.vertexPositionAttribute,this.vBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vBuffer1),t.enableVertexAttribArray(e.vertexPositionAttribute1),t.vertexAttribPointer(e.vertexPositionAttribute1,this.vBuffer1.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vBuffer2),t.enableVertexAttribArray(e.vertexPositionAttribute2),t.vertexAttribPointer(e.vertexPositionAttribute2,this.vBuffer2.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vmBuffer),t.enableVertexAttribArray(e.vertexMorphAttribute),t.vertexAttribPointer(e.vertexMorphAttribute,this.vmBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.cBuffer),t.enableVertexAttribArray(e.textureCoordAttribute),t.vertexAttribPointer(e.textureCoordAttribute,this.cBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.bwBuffer),t.enableVertexAttribArray(e.boneWeightAttribute),t.vertexAttribPointer(e.boneWeightAttribute,this.bwBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.biBuffer),t.enableVertexAttribArray(e.boneIndicesAttribute),t.vertexAttribPointer(e.boneIndicesAttribute,this.biBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vnBuffer),t.enableVertexAttribArray(e.vertexNormalAttribute),t.vertexAttribPointer(e.vertexNormalAttribute,this.vnBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.veBuffer),t.enableVertexAttribArray(e.vertexEdgeAttribute),t.vertexAttribPointer(e.vertexEdgeAttribute,this.veBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mtBuffer1),t.enableVertexAttribArray(e.motionTranslationAttribute1),t.vertexAttribPointer(e.motionTranslationAttribute1,this.mtBuffer1.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mtBuffer2),t.enableVertexAttribArray(e.motionTranslationAttribute2),t.vertexAttribPointer(e.motionTranslationAttribute2,this.mtBuffer2.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mrBuffer1),t.enableVertexAttribArray(e.motionRotationAttribute1),t.vertexAttribPointer(e.motionRotationAttribute1,this.mrBuffer1.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mrBuffer2),t.enableVertexAttribArray(e.motionRotationAttribute2),t.vertexAttribPointer(e.motionRotationAttribute2,this.mrBuffer2.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.iBuffer)},o.prototype._draw=function(t,e,i){this.layer.draw(t,this.layer._BLEND_ALPHA,i,e)},o.prototype.update=function(t){this._initMotions2(),this.dancing&&(this._moveBone(t),this.view.morphType==this.view._MORPH_ON&&this._moveFace());for(var e=0;this.pmd.boneCount>e;e++)this._getBoneMotion(e);this.view.physicsType==this.view._PHYSICS_ON&&this._runPhysics(t),this._initMotionArrays()},o.prototype.draw=function(){var t=this.layer.gl,e=this.layer.shader;this._bindBuffers(),this.view.skinningType==this.view._SKINNING_GPU?(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.vtf),t.uniform1i(e.uVTFUniform,1)):t.uniform1i(e.uVTFUniform,0),t.uniform1i(e.edgeUniform,0),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.DST_ALPHA);for(var i=0,r=0;this.pmd.materialCount>r;r++){var o=this.pmd.materials[r];o.edgeFlag?t.uniform1i(e.shadowUniform,1):t.uniform1i(e.shadowUniform,0),this.view.edgeType==this.view._EDGE_ON&&1==o.color[3]?(t.enable(t.CULL_FACE),t.cullFace(t.FRONT)):(t.disable(t.CULL_FACE),t.cullFace(t.FRONT)),t.uniform4fv(e.diffuseColorUniform,o.color),t.uniform3fv(e.ambientColorUniform,o.mirrorColor),t.uniform3fv(e.specularColorUniform,o.specularColor),t.uniform1f(e.shininessUniform,o.specularity),o.hasToon()?(t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.toonTextures[o.tuneIndex]),t.uniform1i(e.toonTextureUniform,2),t.uniform1i(e.useToonUniform,1)):t.uniform1i(e.useToonUniform,0),this.view.sphereMapType==this.view._SPHERE_MAP_ON&&o.hasSphereTexture()?(t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,this.sphereTextures[r]),t.uniform1i(e.sphereTextureUniform,3),t.uniform1i(e.useSphereMapUniform,1),o.isSphereMapAddition()?t.uniform1i(e.useSphereMapAdditionUniform,1):t.uniform1i(e.useSphereMapAdditionUniform,0)):t.uniform1i(e.useSphereMapUniform,0);var n=this.pmd.materials[r].vertexCount;this._draw(this.textures[r],i,n),i+=n}},o.prototype.drawEdge=function(){var t=this.layer.gl,e=this.layer.shader;t.uniform1i(e.edgeUniform,1),t.uniform1i(e.useToonUniform,0),t.cullFace(t.BACK),t.disable(t.BLEND),t.enable(t.CULL_FACE);for(var i=0,r=0,o=!1,n=0;this.pmd.materialCount>n;n++)r+=this.pmd.materials[n].vertexCount,this.pmd.materials[n].edgeFlag?o=!0:(o&&this._draw(this.textures[0],i,r),i+=r,r=0,o=!1);o&&this._draw(this.textures[0],i,r)},o.prototype.drawShadowMap=function(){var t=this.layer.gl,e=this.layer.shader;this._bindBuffers(),this.view.skinningType==this.view._SKINNING_GPU?(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.vtf),t.uniform1i(e.uVTFUniform,1)):t.uniform1i(e.uVTFUniform,0),t.uniform1i(e.edgeUniform,0),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.cullFace(t.FRONT),this._draw(this.textures[0],0,this.pmd.vertexIndexCount)},o.prototype._runPhysics=function(t){1==t?this.physics.simulate(this.motions):this.physics.simulateFrame(this.motions,t)},o.prototype._loadFromVMD=function(t){this.vmd.loadMotion(),this.view.morphType==this.view._MORPH_ON&&this.vmd.loadFace(),this.vmd.step(t),this.frame+=t},o.prototype._moveFace=function(){for(var t=!1,e=0;this.pmd.faceCount>e;e++){var i=this.vmd.getFace(this.pmd.faces[e]);i.available&&(this._moveMorph(this.pmd.faces[e].id,i.weight),t=!0)}if(t)for(var r=this.pmd.faces[0],e=0;r.vertexCount>e;e++){var o=r.vertices[e],n=o.index*this._V_ITEM_SIZE;this.vmArray[n+0]=0,this.vmArray[n+1]=0,this.vmArray[n+2]=0}},o.prototype._moveBone=function(t){this._loadFromVMD(t);for(var e=0;this.pmd.boneCount>e;e++)this._getBoneMotion(e);this.view.ikType==this.view._IK_ON&&this._resolveIK()},n.vec3.clear=function(t){t[0]=0,t[1]=0,t[2]=0},n.quat4.clear=function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1},o.prototype._getOriginalBoneMotion=function(t){return this.dancing?this.vmd.getBoneMotion(t):this.originalMotions[t.name]},o.prototype._getBoneMotion=function(t){var e=this.motions[t];return e.done||this._resolveFK(e,t),e},o.prototype._resolveFK=function(t,e){var i=this._getOriginalBoneMotion(this.pmd.bones[e]),r=this.pmd.bones[e];if(65535===this.pmd.bones[e].parentIndex)this.vec3.add(r.position,i.location,t.p),this.vec3.add(t.p,this.basePosition,t.p),this.quat4.set(i.rotation,t.r);else{var o=this._getBoneMotion(r.parentIndex),n=this.pmd.bones[r.parentIndex];this.quat4.multiply(o.r,i.rotation,t.r),this.vec3.subtract(r.position,n.position,t.p),this.vec3.add(t.p,i.location,t.p),this.quat4.multiplyVec3(o.r,t.p,t.p),this.vec3.add(t.p,o.p,t.p)}t.done=!0},o.prototype._resolveIK=function(){for(var t=this.vec3.create(),e=this.vec3.create(),i=this.vec3.create(),r=this.quat4.create(),o=this.quat4.create(),n=0;this.pmd.ikCount>n;n++){var s=this.pmd.iks[n],a=this.pmd.bones[s.targetBoneIndex],h=this.pmd.bones[a.parentIndex],p=this._getBoneMotion(s.index),u=this._getBoneMotion(s.targetBoneIndex),f=s.iteration,l=s.chainLength;this.vec3.subtract(a.position,h.position,t);for(var c=.1*this.vec3.length(t),m=0;f>m&&(this.vec3.subtract(u.p,p.p,t),c<=this.vec3.length(t));m++)for(var _=0;l>_;_++){var d=s.childBoneIndices[_],y=this.pmd.bones[d],v=this._getBoneMotion(d);u=this._getBoneMotion(s.targetBoneIndex),this.vec3.subtract(u.p,v.p,e),this.vec3.subtract(p.p,v.p,i),this.vec3.cross(e,i,t);var g=this.vec3.length(e),T=this.vec3.length(i),A=this.vec3.length(t),E=A/T/g;if(!isNaN(E)&&!(c>g||c>T||.001>E)){var I=(_+1)*s.limitation*4,C=this.Math.asin(E);this.vec3.dot(e,i)<0&&(C=3.141592653589793-C),C>I&&(C=I),this.vec3.scale(t,this.Math.sin(C/2)/A,t),this.vec3.set(t,r),r[3]=this.Math.cos(C/2);var M=this._getBoneMotion(y.parentIndex).r;if(this.quat4.inverse(M,o),this.quat4.multiply(o,r,o),this.quat4.multiply(o,v.r,o),this.pmd.bones[d].isKnee()){var b=o[3]>1?1:o[3];this.quat4.set([-this.Math.sqrt(1-b*b),0,0,b],o),this.quat4.inverse(v.r,r),this.quat4.multiply(o,r,r),this.quat4.multiply(M,r,r)}this.quat4.normalize(o,this.vmd.getBoneMotion(y).rotation),this.quat4.multiply(r,v.r,v.r),this.motions[s.targetBoneIndex].done=!1;for(var F=0;_>=F;F++)this.motions[s.childBoneIndices[F]].done=!1}}}},o.prototype._moveMorph=function(t,e){if(0!=t)for(var i=this.pmd.faces[t],r=this.pmd.faces[0],o=0;i.vertexCount>o;o++){var n=r.vertices[i.vertices[o].index],s=n.index*this._V_ITEM_SIZE;this.vmArray[s+0]+=i.vertices[o].position[0]*e,this.vmArray[s+1]+=i.vertices[o].position[1]*e,this.vmArray[s+2]+=i.vertices[o].position[2]*e}},t.exports=o},126:function(t,e,i){"use strict";function r(t){this.layer=t,this.modelViews=[],this.vmd=null,this.audio=null,this.eye=[0,0,0],this.center=[0,0,0],this.up=[0,1,0],this.cameraTranslation=[0,0,0],this.cameraQuaternion=[0,0,0,1],this.cameraDistance=0,this.frame=0,this.dframe=1,this.camera={},this.camera.location=[0,0,0],this.camera.rotation=[0,0,0],this.length=0,this.angle=0,this.oldDate=null,this.startDate=null,this.audioStart=!1,this.dancing=!1,this.elapsedTime=0,this.skinningType=null,this.lightingType=null,this.ikType=null,this.edgeType=null,this.morphType=null,this.sphereMapType=null,this.shadowMappingType=null,this.lightColor=[0,0,0],this.runType=null,this.stageType=null,this.effectFlag=null,this.audioType=null,this.physicsType=null,this.setLightingType(this._LIGHTING_ON),this.setSkinningType(this._SKINNING_CPU_AND_GPU),this.setIKType(this._IK_ON),this.setMorphType(this._MORPH_ON),this.setSphereMapType(this._SPHERE_MAP_ON),this.setShadowMappingType(this._SHADOW_MAPPING_OFF),this.setEdgeType(this._EDGE_ON),this.setRunType(this._RUN_REALTIME_ORIENTED),this.setStageType(this._STAGE_2),this.setEffectFlag(this._EFFECT_OFF),this.setAudioType(this._AUDIO_ON),this.setPhysicsType(this._PHYSICS_ON),this.setLightColor(1)}var o=i(17);r.prototype.Math=Math,r.prototype.vec3=o.vec3,r.prototype.quat4=o.quat4,r.prototype.mat4=o.mat4,r.prototype._FRAME_S=1/60,r.prototype._FRAME_MS=1/60*1e3,r.prototype._PHYSICS_OFF=0,r.prototype._PHYSICS_ON=1,r.prototype._PHYSICS_WORKERS_ON=2,r.prototype._SKINNING_CPU=0,r.prototype._SKINNING_GPU=1,r.prototype._SKINNING_CPU_AND_GPU=2,r.prototype._LIGHTING_OFF=0,r.prototype._LIGHTING_ON=1,r.prototype._LIGHTING_ON_WITH_TOON=2,r.prototype._IK_OFF=0,r.prototype._IK_ON=1,r.prototype._MORPH_OFF=0,r.prototype._MORPH_ON=1,r.prototype._SPHERE_MAP_OFF=0,r.prototype._SPHERE_MAP_ON=1,r.prototype._SHADOW_MAPPING_OFF=0,r.prototype._SHADOW_MAPPING_ON=1,r.prototype._SHADOW_MAPPING_ONLY=2,r.prototype._RUN_FRAME_ORIENTED=0,r.prototype._RUN_REALTIME_ORIENTED=1,r.prototype._RUN_AUDIO_ORIENTED=2,r.prototype._AUDIO_OFF=0,r.prototype._AUDIO_ON=1,r.prototype._EDGE_OFF=0,r.prototype._EDGE_ON=1,r.prototype._STAGE_OFF=0,r.prototype._STAGE_1=1,r.prototype._STAGE_2=2,r.prototype._STAGE_3=3,r.prototype._EFFECT_OFF=0,r.prototype._EFFECT_BLUR=1,r.prototype._EFFECT_GAUSSIAN=2,r.prototype._EFFECT_DIFFUSION=4,r.prototype._EFFECT_DIVISION=8,r.prototype._EFFECT_LOW_RESO=16,r.prototype._EFFECT_FACE_MOSAIC=32,r._PHYSICS_OFF=r.prototype._PHYSICS_OFF,r._PHYSICS_ON=r.prototype._PHYSICS_ON,r._PHYSICS_WORKERS_ON=r.prototype._PHYSICS_WORKERS_ON,r._SKINNING_CPU=r.prototype._SKINNING_CPU,r._SKINNING_GPU=r.prototype._SKINNING_GPU,r._SKINNING_CPU_AND_GPU=r.prototype._SKINNING_CPU_AND_GPU,r._LIGHTING_OFF=r.prototype._LIGHTING_OFF,r._LIGHTING_ON=r.prototype._LIGHTING_ON,r._LIGHTING_ON_WITH_TOON=r.prototype._LIGHTING_ON_WITH_TOON,r._IK_OFF=r.prototype._IK_OFF,r._IK_ON=r.prototype._IK_ON,r._MORPH_OFF=r.prototype._MORPH_OFF,r._MORPH_ON=r.prototype._MORPH_ON,r._SPHERE_MAP_OFF=r.prototype._SPHERE_MAP_OFF,r._SPHERE_MAP_ON=r.prototype._SPHERE_MAP_ON,r._SHADOW_MAPPING_OFF=r.prototype._SHADOW_MAPPING_OFF,r._SHADOW_MAPPING_ON=r.prototype._SHADOW_MAPPING_ON,r._SHADOW_MAPPING_ONLY=r.prototype._SHADOW_MAPPING_ONLY,r._RUN_FRAME_ORIENTED=r.prototype._RUN_FRAME_ORIENTED,r._RUN_REALTIME_ORIENTED=r.prototype._RUN_REALTIME_ORIENTED,r._RUN_AUDIO_ORIENTED=r.prototype._RUN_AUDIO_ORIENTED,r._AUDIO_OFF=r.prototype._AUDIO_OFF=0,r._AUDIO_ON=r.prototype._AUDIO_ON=1,r._EDGE_OFF=r.prototype._EDGE_OFF,r._EDGE_ON=r.prototype._EDGE_ON,r._STAGE_OFF=r.prototype._STAGE_OFF,r._STAGE_1=r.prototype._STAGE_1,r._STAGE_2=r.prototype._STAGE_2,r._STAGE_3=r.prototype._STAGE_3,r._EFFECT_OFF=r.prototype._EFFECT_OFF,r._EFFECT_BLUR=r.prototype._EFFECT_BLUR,r._EFFECT_GAUSSIAN=r.prototype._EFFECT_GAUSSIAN,r._EFFECT_DIFFUSION=r.prototype._EFFECT_DIFFUSION,r._EFFECT_DIVISION=r.prototype._EFFECT_DIVISION,r._EFFECT_LOW_RESO=r.prototype._EFFECT_LOW_RESO,r._EFFECT_FACE_MOSAIC=r.prototype._EFFECT_FACE_MOSAIC,r.prototype.addModelView=function(t){this.modelViews.push(t)},r.prototype.getModelView=function(t){return this.modelViews[t]},r.prototype.getModelNum=function(){return this.modelViews.length},r.prototype.setup=function(){for(var t=0;this.modelViews.length>t;t++)this.modelViews[t].setup();this.elapsedTime=0},r.prototype.setVMD=function(t){this.vmd=t,this.vmd.supply()},r.prototype.setAudio=function(t,e){this.audio={},this.audio.audio=t,this.audio.offset=e},r.prototype.startDance=function(){this.vmd.setup(this.modelViews[0].pmd),this.elapsedTime=0,this.dancing=!0,this.oldDate=null,this.startDate=Date.now(),this.frame=0,this.dframe=0;for(var t=0;this.modelViews.length>t;t++)this.modelViews[t].setVMD(this.vmd.clone()),this.modelViews[t].startDance()},r.prototype.setEye=function(t){for(var e=0;this.eye.length>e;e++)this.eye[e]=t[e];this.center[0]=t[0],this.center[1]=t[1],this.resetCameraMove()},r.prototype.setPhysicsType=function(t){this.physicsType=t},r.prototype.setSkinningType=function(t){this.skinningType=t},r.prototype.setLightingType=function(t){this.lightingType=t},r.prototype.setLightColor=function(t){this.lightColor[0]=t,this.lightColor[1]=t,this.lightColor[2]=t},r.prototype.setIKType=function(t){this.ikType=t},r.prototype.setMorphType=function(t){this.morphType=t},r.prototype.setSphereMapType=function(t){this.sphereMapType=t},r.prototype.setShadowMappingType=function(t){this.shadowMappingType=t},r.prototype.setRunType=function(t){this.runType=t},r.prototype.setStageType=function(t){this.stageType=t},r.prototype.setEffectFlag=function(t){this.effectFlag=t},r.prototype.setAudioType=function(t){this.audioType=t},r.prototype.setEdgeType=function(t){this.edgeType=t},r.prototype.moveCameraQuaternion=function(t){this.quat4.multiply(this.cameraQuaternion,t,this.cameraQuaternion)},r.prototype.moveCameraQuaternionByXY=function(t,e){t=-t,e=-e;var i=this.Math.sqrt(t*t+e*e);if(0!=i){var r=i*this.Math.PI,o=this.Math.sin(r)/i,n=this.quat4.create([e*o,t*o,0,this.Math.cos(r)]);return this.moveCameraQuaternion(n),!0}return!1},r.prototype.moveCameraTranslation=function(t,e){e=-e,this.cameraTranslation[0]+=50*t,this.cameraTranslation[1]+=50*e},r.prototype.resetCameraMove=function(){this.cameraDistance=0,this.cameraTranslation[0]=0,this.cameraTranslation[1]=0,this.cameraTranslation[2]=0,this.cameraQuaternion[0]=0,this.cameraQuaternion[1]=0,this.cameraQuaternion[2]=0,this.cameraQuaternion[3]=1},r.prototype.moveCameraForward=function(t){t>0&&(this.cameraDistance-=25),0>t&&(this.cameraDistance+=25),this.cameraDistance>-100||(this.cameraDistance=-99)},r.prototype._getCalculatedCameraParams=function(t,e,i){this.vec3.set(this.eye,t),this.vec3.set(this.center,e),this.vec3.set(this.up,i),this.quat4.multiplyVec3(this.cameraQuaternion,t,t),this.quat4.multiplyVec3(this.cameraQuaternion,i,i);var r=[0,0,0];this.vec3.set(this.cameraTranslation,r),this.quat4.multiplyVec3(this.cameraQuaternion,r,r),this.vec3.add(t,r,t),this.vec3.add(e,r,e);var o=[0,0,0];this.vec3.subtract(t,e,o),t[0]+=o[0]*this.cameraDistance*.01,t[1]+=o[1]*this.cameraDistance*.01,t[2]+=o[2]*this.cameraDistance*.01},r.prototype._calculateDframe=function(){var t=Date.now();if(this.runType==this._RUN_FRAME_ORIENTED)this.dframe=1,this.elapsedTime+=this._FRAME_MS;else if(this.runType!=this._RUN_REALTIME_ORIENTED&&this.dancing&&null!==this.audio)if(this.audioStart&&(t=1e3*this.audio.audio.currentTime+this.startDate+this.audio.offset*this._FRAME_MS),this.oldDate){var e=this.elapsedTime,i=this.elapsedTime/this._FRAME_MS|0;this.elapsedTime+=t-this.oldDate;var r=this.elapsedTime/this._FRAME_MS|0,o=r-i;o>0||(t=this.oldDate,o=0,this.elapsedTime=e),this.dframe=o}else this.dframe=0;else if(this.oldDate){var e=this.elapsedTime,i=this.elapsedTime/this._FRAME_MS|0;
this.elapsedTime+=t-this.oldDate;var r=this.elapsedTime/this._FRAME_MS|0,o=r-i;o>0||(t=this.oldDate,o=0,this.elapsedTime=e),this.dframe=o}else this.dframe=0;this.oldDate=t},r.prototype._controlAudio=function(){this.audio&&!this.audioStart&&this.audioType!=this._AUDIO_OFF&&(this.audio.offset&&this.audio.offset>this.frame||(this.audio.audio.play(),0>this.audio.offset&&(this.audio.audio.currentTime=-this.audio.offset*this._FRAME_S),this.audioStart=!0))},r.prototype.update=function(){if(this._controlAudio(),this._calculateDframe(),0!=this.dframe){this.dancing&&this._loadFromVMD(this.dframe);for(var t=0;this.modelViews.length>t;t++)this.modelViews[t].update(this.dframe)}},r.prototype.draw=function(){if(0!=this.dframe){var t=this.layer,e=t.gl,i=t.shader,r=this.effectFlag&this._EFFECT_BLUR?t.postEffects.blur:this.effectFlag&this._EFFECT_GAUSSIAN?t.postEffects.gaussian:this.effectFlag&this._EFFECT_DIFFUSION?t.postEffects.diffusion:this.effectFlag&this._EFFECT_DIVISION?t.postEffects.division:this.effectFlag&this._EFFECT_LOW_RESO?t.postEffects.low_reso:this.effectFlag&this._EFFECT_FACE_MOSAIC?t.postEffects.face_mosaic:null;if(this.shadowMappingType!=this._SHADOW_MAPPING_OFF){this.shadowMappingType==this._SHADOW_MAPPING_ONLY?(e.bindFramebuffer(e.FRAMEBUFFER,null),t.viewport(),t.perspective(t.viewAngle)):(e.bindFramebuffer(e.FRAMEBUFFER,t.shadowFrameBuffer.f),e.viewport(0,0,t.shadowFrameBufferSize,t.shadowFrameBufferSize),this.mat4.perspective(t.viewAngle,1,t.viewNear,t.viewFar,t.pMatrix)),t.identity(),t.lookAt(t.lightPosition,t.lightCenter,t.lightUpDirection),t.registerLightMatrix(),e.uniform1i(i.shadowGenerationUniform,1),e.uniform1i(i.shadowTextureUniform,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var o=0;this.modelViews.length>o;o++)this.modelViews[o].drawShadowMap();if(e.flush(),e.bindFramebuffer(e.FRAMEBUFFER,null),e.uniform1i(i.shadowMappingUniform,1),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.layer.shadowFrameBuffer.t),e.uniform1i(i.shadowTextureUniform,4),e.uniformMatrix4fv(i.lightMatrixUniform,!1,t.lightMatrix),this.shadowMappingType==this._SHADOW_MAPPING_ONLY)return}else e.uniform1i(i.shadowMappingUniform,0);this._setCamera(),this._setDrawParameters(),e.uniform1i(i.shadowGenerationUniform,0);var n=null===r?null:r.shader;this.effectFlag!=this._EFFECT_OFF?r.bindFrameBufferForScene():e.bindFramebuffer(e.FRAMEBUFFER,null),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var o=0;this.modelViews.length>o;o++)this.modelViews[o].draw(),this.edgeType==this._EDGE_ON&&this.modelViews[o].drawEdge();this.stageType!=this._STAGE_OFF&&(this._drawStage(),this.effectFlag==this._EFFECT_OFF&&e.useProgram(i)),e.flush(),this.effectFlag!=this._EFFECT_OFF&&(e.useProgram(n),n.frame=this.frame,r.draw(this),e.useProgram(i))}},r.prototype._setCamera=function(){var t=this.layer;t.viewport();var e=60;this.dancing&&this.vmd.getCamera().available&&(e=this.vmd.getCamera().angle,this.vmd.getCalculatedCameraParams(this.eye,this.center,this.up)),t.perspective(e),t.identity();var i=[0,0,0],r=[0,0,0],o=[0,0,0];this._getCalculatedCameraParams(i,r,o),t.lookAt(i,r,o)},r.prototype._setDrawParameters=function(){var t=this.layer,e=t.gl,i=t.shader;e.uniform1i(i.uSkinningTypeUniform,this.skinningType),e.uniform1i(i.uLightingTypeUniform,this.lightingType),e.uniform3fv(i.lightColorUniform,this.lightColor),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},r.prototype._drawStage=function(){for(var t=this.layer,e=this.layer.stageShaders[this.stageType-1],i=[],r=[],o=[],n=0;this.modelViews.length>n;n++){var s=this.modelViews[n];i.push(s.skinningOneBone(s.pmd.centerBone)),r.push(s.skinningOneBone(s.pmd.leftFootBone)),o.push(s.skinningOneBone(s.pmd.rightFootBone))}i=[].concat.apply([],i),r=[].concat.apply([],r),o=[].concat.apply([],o);var a=!1;this.shadowMappingType==this._SHADOW_MAPPING_ON&&(a=!0),e.draw(this.frame,this.modelViews.length,i,r,o,a,t.lightMatrix)},r.prototype._loadFromVMD=function(t){this.vmd.loadCamera(),this.vmd.loadLight(),this.vmd.step(t),this.frame+=t},r.prototype._moveLight=function(){var t=this.vmd.getLight();t.available&&(this.layer.gl.uniform3fv(this.layer.shader.lightColorUniform,t.color),this.layer.lightPosition=t.location)},t.exports=r},127:function(t,e,i){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t){this.parent=p.default,this.parent.call(this,t)}var n=i(29),s=r(n),a=i(51),h=i(52),p=r(h);(0,s.default)(o,p.default),o.prototype._HEADER_STRUCTURE={magic:{type:"char",isArray:!0,size:30},modelName:{type:"char",isArray:!0,size:20}},o.prototype._MOTIONS_STRUCTURE={count:{type:"uint32"},motions:{type:"object",isArray:!0,size:"count"}},o.prototype._MOTION_STRUCTURE={boneName:{type:"strings",isArray:!0,size:15},frameNum:{type:"uint32"},location:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:4},interpolation:{type:"uint8",isArray:!0,size:64}},o.prototype._FACES_STRUCTURE={count:{type:"uint32"},faces:{type:"object",isArray:!0,size:"count"}},o.prototype._FACE_STRUCTURE={name:{type:"strings",isArray:!0,size:15},frameNum:{type:"uint32"},weight:{type:"float"}},o.prototype._CAMERAS_STRUCTURE={count:{type:"uint32"},cameras:{type:"object",isArray:!0,size:"count"}},o.prototype._CAMERA_STRUCTURE={frameNum:{type:"uint32"},length:{type:"float"},location:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:3},interpolation:{type:"uint8",isArray:!0,size:24},angle:{type:"uint32"},perspective:{type:"uint8"}},o.prototype._LIGHTS_STRUCTURE={count:{type:"uint32"},lights:{type:"object",isArray:!0,size:"count"}},o.prototype._LIGHT_STRUCTURE={frameNum:{type:"uint32"},color:{type:"float",isArray:!0,size:3},location:{type:"float",isArray:!0,size:3}},o.prototype.parse=function(){this.offset=0;var t=new a.VMD;return this._parseHeader(t),this._parseMotions(t),this._parseFaces(t),this._parseCameras(t),this._parseLights(t),t},o.prototype.valid=function(){var t=this.offset;this.offset=0;var e=new a.VMD;return this._parseHeader(e),this.offset=t,e.valid()},o.prototype._parseHeader=function(t){var e=this._HEADER_STRUCTURE;t.header=new a.VMDHeader,this._parseObject(t.header,e)},o.prototype._parseMotions=function(t){var e=this._MOTIONS_STRUCTURE;t.motionCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.motions.length=0;for(var i=0;t.motionCount>i;i++)this._parseMotion(t,i)},o.prototype._parseMotion=function(t,e){var i=this._MOTION_STRUCTURE,r=new a.VMDMotion(e);this._parseObject(r,i),t.motions[e]=r},o.prototype._parseFaces=function(t){var e=this._FACES_STRUCTURE;t.faceCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.faces.length=0;for(var i=0;t.faceCount>i;i++)this._parseFace(t,i)},o.prototype._parseFace=function(t,e){var i=this._FACE_STRUCTURE,r=new a.VMDFace(e);this._parseObject(r,i),t.faces[e]=r},o.prototype._parseCameras=function(t){var e=this._CAMERAS_STRUCTURE;t.cameraCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.cameras.length=0;for(var i=0;t.cameraCount>i;i++)this._parseCamera(t,i)},o.prototype._parseCamera=function(t,e){var i=this._CAMERA_STRUCTURE,r=new a.VMDCamera(e);this._parseObject(r,i),t.cameras[e]=r},o.prototype._parseLights=function(t){var e=this._LIGHTS_STRUCTURE;t.lightCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.lights.length=0;for(var i=0;t.lightCount>i;i++)this._parseLight(t,i)},o.prototype._parseLight=function(t,e){var i=this._LIGHT_STRUCTURE,r=new a.VMDLight(e);this._parseObject(r,i),t.lights[e]=r},t.exports=o},128:function(t,e){"use strict";var i=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},r=function(t,e){var r=o(t,s(i(n(i(t,[e[0],e[1],e[2]]),s(t,e[3])),[e[0],e[1],e[2]]),2));return r},o=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},n=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},s=function(t,e){return e.length?[t[0]*e[0],t[1]*e[1],t[2]*e[2]]:[t[0]*e,t[1]*e,t[2]*e]},a=function(t,e,i){return o(s(t,n([1,1,1],[i,i,i])),s(e,[i,i,i]))};t.exports={cross:i,qtransform:r,arrayAdd:o,arrayMns:n,arrayMuti:s,mix:a}},129:function(t,e){"use strict";function i(t,e,i){var r="",o="";8==t?o="0":16==t&&(o="0x");for(var n=0;i>n;n++)r+="0";return o+(r+e.toString(t)).substr(-1*i)}t.exports=i},158:function(t,e,i){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=Object.assign||function(t){for(var e=1;arguments.length>e;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},n=i(50),s=(r(n),i(124)),a=r(s),h=i(125),p=r(h),u=i(126),f=r(u),l=i(51),c=(r(l),i(127)),m=r(c),_=i(49),d=r(_),y=function(t){console.error("[Easycanvas-webgl] "+t)},v={},g="processing",T=function(t,e,i){var r=new a.default(e);if(!r.valid())return void y("PMD Parse Error.");var o=r.parse();o.setup();var n=o.vertices.map(function(t){return t.position}).join(",").split(",").map(function(t){return+t}),s=o.vertices.map(function(t){return t.normal}).join(",").split(","),h=o.vertices.map(function(t){return t.uv}).join(",").split(","),p=o.vertexIndices.map(function(t){return t.index}),u={vertices:n,normals:s,textures:h,indices:p};o.$vertices=n,v[t]={data:u,pmd:o},i(u,o)},A=function(t,e){for(var i=[],r=[],o=0;t.length>o;o++){if(r[o]=new m.default(t[o]),!r[o].valid())return void y("VMD Parse Error.");i[o]=r[o].parse()}for(var n=i[0],o=1;t.length>o;o++)n.merge(i[o]);e({start:function(t,e){var i=(new d.default(t),new f.default),r=new p.default(null,t,i);r.setup(),r._initMotions(),i.setup(),i.addModelView(r),i.setVMD(n),i.startDance();var o=r.getVerticals;setInterval(function(){i.update();for(var t=0,r=e.length/3;r>t;t++){var n=o(t);e[3*t+0]=n[0],e[3*t+1]=n[1],e[3*t+2]=n[2]}e.$cacheBuffer=void 0},50)}})},E=function t(e,i){var r=2>=arguments.length||void 0===arguments[2]||arguments[2];if(r){if(v[e])return void(v[e]===g?setTimeout(function(){t(e,i)},100):i(v[e].data,v[e].pmd));v[e]=g}var o=e,n=new XMLHttpRequest;n.responseType="arraybuffer",n.onload=function(){T(e,n.response,i)},n.onerror=function(t){y("PMD File Loaded Error.")},n.open("GET",o,!0),n.send(null)},I=function(t,e,i,r){i=i||0,r=r||[];var o=t.pop?t.length[i]:t,n=new XMLHttpRequest;n.responseType="arraybuffer",n.onload=function(){r.push(n.response),A(r,e)},n.onerror=function(t){y("VMD File Loaded Error.")},n.open("GET",o,!0),n.send(null)},C=function(t){if(t.webgl&&t.webgl.pmd){var e=t.webgl.pmd,i=t.webgl.imgPath,r=t.webgl.cache!==!1,n=this,s=void 0;E(e,function(r,a){n.webgl={};var h=r.vertices,p=r.normals,u=r.textures,f=r.indices;delete t.webgl.pmd,delete t.webgl.imgPath,delete t.webgl.cache;var l=0;a.materials.forEach(function(r,s){var a=v[e]["currentIndices"+s]||f.slice(l,l+r.vertexCount);v[e]["currentIndices"+s]=a,n.add({name:r.fileName,webgl:o(window.Easycanvas.webglShapes.custom({vertices:h,normals:p,indices:a,textures:u,img:r.fileName?i+r.fileName:void 0,colors:r.fileName?void 0:r.color.map(function(t){return 255*t}).slice(0,3)}),t.webgl)}),l+=r.vertexCount}),n.vmdStart=function(t){I(t,function(t){n.trigger("webgl-vmd-loaded"),t.start(a,n.children[0].webgl.vertices)})},s&&n.vmdStart(s),n.trigger("webgl-pmd-loaded")},r),n.vmdStart=function(t){s=t}}},M="undefined"!=typeof window;M&&window.Easycanvas?(Easycanvas.loaderPMD=E,Easycanvas.loaderVMD=I,Easycanvas.extend(C)):t.exports={loaderPMD:E,loaderVMD:I,classInit:C}}})});